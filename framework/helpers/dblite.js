"use strict";function dblite(){function e(e){c.listeners("close").length?c.emit("close",e):log("bye bye")}function r(){E.length&&c._query.apply(c,E.shift())}function t(e){if(n&&1<n.length){var r=n;S=d=h=!1,n=i=null,g=!0,r.call(c,new Error(e.toString()),null)}else c.listeners("error").length?c.emit("error",""+e):console.error(""+e)}_defineCSVEOL();var n,i,s="---"+crypto.randomBytes(64).toString("base64")+"---",o='"'+s+'" AS "'+s+'";'+EOL,a=-(s.length+EOL_LENGTH),l="",c=new EventEmitter,u=spawn(1===bin.length?bin[0]:"."+PATH_SEP+bin[bin.length-1],normalizeFirstArgument(Array.prototype.slice.call(arguments)).concat("-csv").reverse(),{cwd:bin.slice(0,-1).join(PATH_SEP)||process.cwd(),env:process.env,encoding:"utf8",detached:!0,stdio:["pipe","pipe","pipe"]}),E=[],p=!1,f=!1,S=!1,d=!1,g=!1,O=!1,y=0,h=!1;return s+=EOL,u.stderr.on("data",function(e){f=!1,t(e)}),u.stdin.on("error",t),u.stdout.on("error",t),u.stderr.on("error",t),u.stdout.on("data",function(e){var t,o,u,E,p,A,L,_;if(g)return l="",g=!1,void(c.ignoreErrors&&(f=!1,r()));y+=e.length,O&&e.toString().slice(a)===s&&(l="",e=s,O=!1,console.log("out of memory test",y,sqlTest)),O&&(e=""),l.length+e.length>=1e8&&(l="",O=!0),(l+=e.toString()).slice(a)===s&&(y=0,(p=(t=l.slice(0,a)).slice(a)===s)&&(t=t.slice(0,a)),l="",f=!1,S||d?(A=S,L=h,S=d=h=f,u=n,E=i,A&&(o=L?t:parseCSV(t),p&&isArray(o)&&o.length&&(null==E?E=o[0]:isArray(E)||o[0].forEach(enrichFields,E),o.shift())),n=i=null,r(),u&&(_=!L&&E?isArray(E)?o.map(row2object,E):o.map(row2parsed,parseFields(E)):o,1<u.length?u.call(c,null,_):u.call(c,_))):(r(),t.length&&(c.listeners("info").length?c.emit("info",EOL+t):log(EOL+t))))}),u.unref?(u.on("close",e),u.unref()):(IS_NODE_06=!0,u.stdout.on("close",e)),c.ignoreErrors=!1,c.close=function(){p||(c.query(".exit"),p=!0)},c.lastRowID=function(e,r){return c.query("SELECT ROWID FROM `"+e+"` ORDER BY ROWID DESC LIMIT 1",function(e){var t,n=e[0];if(!(n instanceof Array))for(t in n)if(n.hasOwnProperty(t)){n=[n[t]];break}(r||log).call(c,n[0])}),c},c.plain=function(e){if("string"!=typeof e)throw new Error("Argument #1 should be a string");return e={query:e,dontParse:!0},c._query.apply(c,arguments)},c.query=function(e){if("string"!=typeof e)throw new Error("Argument #1 should be a string");return e={query:e,dontParse:!1},c._query.apply(c,arguments)},c._query=function(e,s,a,l){if(p)return t("closing"),c;if(f)return E.push(arguments),c;"object"===(void 0===e?"undefined":_typeof(e))&&(h=e.dontParse,e=e.query);try{if(S=SELECT.test(e),sqlTest="",S){switch(sqlTest=e+" "+("[object Object]"==Object.prototype.toString.call(s)?JSON.stringify(s):""),f=!0,arguments.length){case 4:n=l,i=a,e=replaceString(e,s);break;case 3:"function"==typeof a?(n=a,a=null,HAS_PARAMS.test(e)?(i=null,e=replaceString(e,s)):i=s):(n=log,i=a,e=replaceString(e,s));break;case 2:"function"==typeof s?(i=null,n=s):(n=log,HAS_PARAMS.test(e)?(i=null,e=replaceString(e,s)):i=s);break;default:n=log,i=null}u.stdin.write(sanitize(e)+"SELECT "+o)}else{if(h)throw h=!1,new Error("not a select");if("."===e[0])f=!0,u.stdin.write(e+EOL+"SELECT "+o);else switch(arguments.length){case 1:case 2:if("function"!=typeof s){u.stdin.write(sanitize(HAS_PARAMS.test(e)?replaceString(e,s):e)),setImmediate(r);break}a=s,s=null;case 3:f=d=!0,n=a,u.stdin.write(sanitize(HAS_PARAMS.test(e)?replaceString(e,s):e)+EOL+"SELECT "+o)}}}catch(e){f=!1,n&&n(new Error("got exception: "+e.toString()))}return c},c.parseCSV=parseCSV,c.escape=escape,c.row2object=row2object,c.row2parsed=row2parsed,c.parseFields=parseFields,c}function enrichFields(e){var r=this.hasOwnProperty(e),t=r&&this[e];delete this[e],this[e]=r?t:String}function normalizeFirstArgument(e){return":memory:"!==e[0]&&(e[0]=path.resolve(e[0])),e}function parseCSV(e){_defineCSVEOL();for(var r,t,n,i,s,o=[],a=[],l=0,c=0,u=e.length,E=0;E<u;E++){switch(e[E]){case'"':t=!0,r=E;do{switch(i=e.indexOf('"',r+1),e[r=i+1]){case EOL[0]:if(2===EOL_LENGTH&&e[r+1]!==EOL[1])break;case",":t=!1}}while(t);s=e.slice(E+1,i++).replace(DOUBLE_DOUBLE_QUOTES,'"');break;default:i=e.indexOf(",",E),n=e.indexOf(EOL,E),i<0&&(i=u-EOL_LENGTH),s=e.slice(E,n<i?i=n:i)}o[l++]=s,e[E=i]===EOL[0]&&(1===EOL_LENGTH||e[E+1]===EOL[1]&&++E)&&(a[c++]=o,o=[],l=0)}return a}function parseFields(e){for(var r,t=Object.keys(e),n=[],i=t.length,s=0;s<i;s++)r=e[t[s]],n[s]=r===Boolean?$Boolean:r===Date?$Date:r||String;return{f:t,p:n}}function replaceString(e,r){return isArray(r)?(paramsIndex=0,paramsArray=r,e=e.replace(REPLACE_QUESTIONMARKS,replaceQuestions)):r&&(paramsObject=r,e=e.replace(REPLACE_PARAMS,replaceParams)),paramsArray=paramsObject=null,e}function replaceParams(e,r){return escape(paramsObject[r])}function replaceQuestions(){return escape(paramsArray[paramsIndex++])}function row2object(e){for(var r={},t=this.length,n=0;n<t;n++)r[this[n]]=e[n];return r}function row2parsed(e){for(var r={},t=this.f,n=this.p,i=t.length,s=0;s<i;s++)if(n[s]===Buffer)r[t[s]]=n[s](e[s],"hex");else if(n[s]===Array)r[t[s]]=e[s]?e[s].split(","):[];else if(n[s]===String)try{r[t[s]]=JSON.parse(JSON.stringify(e[s]||""))}catch(n){r[t[s]]=e[s]}else r[t[s]]=n[s](e[s]);return r}function escape(e){switch(_defineCSVEOL(),void 0===e?"undefined":_typeof(e)){case"string":return"'"+e.replace(SINGLE_QUOTES,SINGLE_QUOTES_DOUBLED)+"'";case"object":return null==e?"null":Buffer.isBuffer(e)?"X'"+e.toString("hex")+"'":"'"+JSON.stringify(e).replace(SINGLE_QUOTES,SINGLE_QUOTES_DOUBLED)+"'";case"boolean":return e?"1":"0";case"number":if(isFinite(e))return""+e}throw new Error("unsupported data "+e)}function sanitize(e){return e.replace(SANITIZER,"")+SANITIZER_REPLACER}function $Boolean(e){switch(e.toLowerCase()){case"0":case"false":case"null":case"":return!1}return!0}function $Date(e){return new Date(DECIMAL.test(e)?parseInt(e,10):e)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},sqlTest="",isArray=Array.isArray,crypto=require("crypto"),path=require("path"),EventEmitter=require("events").EventEmitter,WIN32="win32"===process.platform,PATH_SEP=path.sep||(WIN32?"\\":"/"),spawn=require("child_process").spawn,DECIMAL=/^[1-9][0-9]*$/,SELECT=/^(?:select|SELECT|pragma|PRAGMA) /,REPLACE_QUESTIONMARKS=/\?/g,REPLACE_PARAMS=/(?:\:|\@|\$)([a-zA-Z_0-9$]+)/g,DOUBLE_DOUBLE_QUOTES=/""/g,SINGLE_QUOTES=/'/g,SINGLE_QUOTES_DOUBLED="''",HAS_PARAMS=/(?:\?|(?:(?:\:|\@|\$)[a-zA-Z_0-9$]+))/,log=console.log.bind(console),bin=["sqlite3"],paramsIndex,paramsArray,paramsObject,IS_NODE_06=!1,EOL,EOL_LENGTH,SANITIZER,SANITIZER_REPLACER,_defineCSVEOL=function(){_defineCSVEOL=function(){};var e=dblite.sqliteVersion||process.env.SQLITE_VERSION||"";e=String(dblite.sqliteVersion||"").replace(/[^.\d]/g,"").split("."),EOL_LENGTH=(EOL="\n").length,SANITIZER=new RegExp("[;"+EOL.split("").map(function(e){return"\\x"+("0"+e.charCodeAt(0).toString(16)).slice(-2)}).join("")+"]+$"),SANITIZER_REPLACER=";"+EOL,e.length||console.warn(["[WARNING] sqlite 3.8.6 changed CSV output","please specify your sqlite version",'via `dblite.sqliteVersion = "3.8.5";`',"or via SQLITE_VERSION=3.8.5"].join(EOL))};Object.defineProperty(dblite,"bin",{get:function(){return bin.join(PATH_SEP)},set:function(e){if(-1<e.indexOf(PATH_SEP)&&(e=path.resolve(e),!require(IS_NODE_06?"path":"fs").existsSync(e)))throw"invalid executable: "+e;bin=e.split(PATH_SEP)}}),dblite.withSQLite=function(e){return dblite.sqliteVersion=e,dblite},module.exports=dblite;