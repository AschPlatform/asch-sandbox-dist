"use strict";var _getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var sqlite3=require("better-sqlite3"),_require=require("util"),isFunction=_require.isFunction,promisify=_require.promisify;function dblite(e){return new DBLiteAdapter(e)}var DBLiteAdapter=function(){function r(e){(0,_classCallCheck3.default)(this,r),this._db=new sqlite3(e)}return(0,_createClass3.default)(r,[{key:"_doQuery",value:function(r,e){try{return this._db.prepare(r).all(e||[])}catch(e){throw app.logger.error("query failed: "+r,e),e}}},{key:"_execute",value:function(r,e){try{return this._db.prepare(r).run(e||[])}catch(e){throw app.logger.error("exec failed: "+r,e),e}}},{key:"_hasResultSet",value:function(e){return e.toLowerCase().startsWith("select")}},{key:"_isPragma",value:function(e){return 0<=e.toLowerCase().indexOf("pragma")}},{key:"_pragma",value:function(e){var r=e.trim().substr("pragma".length);return this._db.pragma(r)}},{key:"query",value:function(e,r){return promisify(this.syncQuery).call(this,e,r)}},{key:"syncQuery",value:function(e,r,t){if(e&&""!==e&&""!==e.trim()){isFunction(r)&&(t=r,r={});var a=void 0,i=e.split(";");try{var u=!0,l=!1,s=void 0;try{for(var n,o=(0,_getIterator3.default)(i);!(u=(n=o.next()).done);u=!0){var c=n.value;""!==c.trim()&&(a=this._isPragma(c)?this._pragma(c):this._hasResultSet(c)?this._doQuery(c,r):this._execute(c,r))}}catch(e){l=!0,s=e}finally{try{!u&&o.return&&o.return()}finally{if(l)throw s}}t&&t(null,a)}catch(e){t&&t(e)}}}},{key:"close",value:function(){this._db&&this._db.close(),app.logger.info("sqlite closed")}}]),r}();module.exports=dblite;