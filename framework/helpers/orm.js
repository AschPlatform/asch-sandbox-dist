"use strict";function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(i,s){try{var a=t[i](s),o=a.value}catch(e){return void n(e)}if(!a.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});e(o)}return r("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),extend=require("util")._extend,jsonSql=require("json-sql")({separatedValues:!1}),dblite=require("./dblite"),PIFY=require("./index").PIFY,JOIN_TRS_FIELDS=["t.timestamp","t.type","t.height"],JOIN_FIELDS_TYPE={"t.timestamp":Number,"t.type":Number,"t.height":Number},Model=function(){function e(t,n){_classCallCheck(this,e),this.schema=t,this.db=n,this.fieldsType={},this.allFields=[],!t.tableFields&&t.fields&&(t.tableFields=t.fields),!t.table&&t.name&&(t.table=t.name);for(var r in t.tableFields){var i=t.tableFields[r];switch(this.allFields.push(i.name),i.type){case"Number":case"BigInt":this.fieldsType[i.name]=Number;break;default:this.fieldsType[i.name]=String}}}return _createClass(e,[{key:"fields",value:function(){return this.allFields}},{key:"sync",value:function(){var e=jsonSql.build(this.schema).query;return this.db.query(e)}},{key:"parseRows",value:function(e,t){var n=this;return t.map(function(t){for(var r={},i=0;i<t.length;++i){var s=e[i];JOIN_FIELDS_TYPE[s]?r[s.split(".").join("_")]=JOIN_FIELDS_TYPE[s](t[i]):r[s=s.split(".")[1]]=n.fieldsType[s](t[i])}return r})}},{key:"findAll",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,i,s,a,o,u,l,c,f,h,d=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=t||{},n=t.fields||this.allFields,n=n.map(function(e){return d.schema.table+"."+e}),"string"==typeof(r=t.sort))r="timestamp"===r?"t."+r:this.schema.table+"."+r;else if("object"===(void 0===r?"undefined":_typeof(r)))for(i in r)"timestamp"===i?r["t."+i]=r[i]:r[this.schema.table+"."+i]=r[i],delete r[i];if(s=null,Array.isArray(t.condition)){s=t.condition.slice();for(a in s)for(o in s[a])s[a][this.schema.table+"."+o]=s[a][o],delete s[a][o]}else if("object"===_typeof(t.condition)){s=extend({},t.condition);for(u in s)s[this.schema.table+"."+u]=s[u],delete s[u]}return l={type:"select",table:this.schema.table,condition:s,fields:n,limit:t.limit,offset:t.offset,sort:r},-1!==this.allFields.indexOf("tid")&&(l.fields=n.concat(JOIN_TRS_FIELDS),(c={})[this.schema.table+".tid"]="t.id",l.join=[{type:"inner",table:"transactions",alias:"t",on:c}]),f=jsonSql.build(l).query,e.next=12,this.db.query(f);case 12:return h=e.sent,e.abrupt("return",this.parseRows(l.fields,h));case 14:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"findOne",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,i,s,a,o,u,l,c,f=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.fields||this.allFields,n=n.map(function(e){return f.schema.table+"."+e}),r=null,Array.isArray(t.condition)){r=t.condition.slice();for(i in r)for(s in r[i])r[i][this.schema.table+"."+s]=r[i][s],delete r[i][s]}else if("object"===_typeof(t.condition)){r=extend({},t.condition);for(a in r)r[this.schema.table+"."+a]=r[a],delete r[a]}return o={type:"select",table:this.schema.table,fields:n,condition:r},-1!==this.allFields.indexOf("tid")&&(o.fields=n.concat(JOIN_TRS_FIELDS),(u={})[this.schema.table+".tid"]="t.id",o.join=[{type:"inner",table:"transactions",alias:"t",on:u}]),l=jsonSql.build(o).query,e.next=9,this.db.query(l);case 9:if((c=e.sent)&&0!==c.length){e.next=12;break}return e.abrupt("return",null);case 12:return e.abrupt("return",this.parseRows(o.fields,c)[0]);case 13:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"create",value:function(e){var t=jsonSql.build({type:"insert",table:this.schema.table,values:e}).query;return this.db.query(t)}},{key:"exists",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.count(t);case 2:return n=e.sent,e.abrupt("return",n>0);case 4:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"count",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=jsonSql.build({type:"select",table:this.schema.table,fields:["count(*)"],condition:t}).query,n=n.replace(/"/g,""),e.next=4,this.db.query(n);case 4:return r=e.sent,e.abrupt("return",Number(r[0][0]));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}(),Transaction=function(){function e(t){_classCallCheck(this,e),this.db=t}return _createClass(e,[{key:"commit",value:function(){return this.db.query("RELEASE SAVEPOINT tmp")}},{key:"rollback",value:function(){return this.db.query("ROLLBACK TO SAVEPOINT tmp")}}]),e}(),Orm=function(){function e(t,n,r,i){_classCallCheck(this,e),this.options=i,this.dblite=dblite(i.storage)}return _createClass(e,[{key:"define",value:function(e,t){return t.type="create",new Model(t,this)}},{key:"query",value:function(e){return PIFY(this.dblite.query)(e)}},{key:"transaction",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.query("SAVEPOINT tmp");case 2:return e.abrupt("return",new Transaction(this));case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"close",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.dblite.close(),e.next=3,PIFY(function(e){setTimeout(e,1e3)})();case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),e}();module.exports=Orm;