"use strict";var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var extend=require("util")._extend,jsonSql=require("json-sql")({separatedValues:!1}),dblite=require("./dblite"),PIFY=require("./index").PIFY,JOIN_TRS_FIELDS=["t.timestamp","t.type","t.height"],JOIN_FIELDS_TYPE={"t.timestamp":Number,"t.type":Number,"t.height":Number},Model=function(){function n(e,t){for(var r in(0,_classCallCheck3.default)(this,n),this.schema=e,this.db=t,this.fieldsType={},this.allFields=[],this.index=["_deleted_"],!e.tableFields&&e.fields&&(e.tableFields=e.fields),!e.table&&e.name&&(e.table=e.name),e.tableFields){var a=e.tableFields[r];switch(this.allFields.push(a.name),a.type){case"Number":case"BigInt":this.fieldsType[a.name]=Number;break;default:this.fieldsType[a.name]=String}a.index&&this.index.push(a.name)}}var t,r,a,i;return(0,_createClass3.default)(n,[{key:"fields",value:function(){return this.allFields}},{key:"sync",value:function(){app.logger.debug("sync schema",this.schema);var e=[];this.schema.tableFields.push({name:"_deleted_",type:"Number",default:0}),e.push(jsonSql.build(this.schema).query);var t=!0,r=!1,a=void 0;try{for(var n,i=(0,_getIterator3.default)(this.index);!(t=(n=i.next()).done);t=!0){var s=n.value;e.push(jsonSql.build({type:"index",table:this.schema.table,name:this.schema.table+"_"+s,indexOn:s}).query)}}catch(e){r=!0,a=e}finally{try{!t&&i.return&&i.return()}finally{if(r)throw a}}return this.db.query(e.join(";"))}},{key:"parseRows",value:function(e,t){return t.map(function(e){var t={};for(var r in e){var a=r;JOIN_FIELDS_TYPE[a]?t[a.split(".").join("_")]=JOIN_FIELDS_TYPE[a](e[r]):t[a=a.indexOf(".")<0?a:a.split(".")[1]]=e[r]}return t})}},{key:"findAll",value:(i=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var r,a,n,i,s,l,u,o,c,d,f,h=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(r=(t=t||{}).fields||this.allFields).map(function(e){return h.schema.table+"."+e}),"string"==typeof(a=t.sort))a="timestamp"===a?"t."+a:this.schema.table+"."+a;else if("object"===(void 0===a?"undefined":(0,_typeof3.default)(a)))for(n in a)"timestamp"===n?a["t."+n]=a[n]:a[this.schema.table+"."+n]=a[n],delete a[n];if(i={},Array.isArray(t.condition))for(s in i=t.condition.slice())for(l in i[s])i[s][this.schema.table+"."+l]=i[s][l],delete i[s][l];else if("object"===(0,_typeof3.default)(t.condition))for(u in i=extend({},t.condition))i[this.schema.table+"."+u]=i[u],delete i[u];return i[this.schema.table+"._deleted_"]=0,o={type:"select",table:this.schema.table,condition:i,fields:r,limit:t.limit,offset:t.offset,sort:a},-1!==this.allFields.indexOf("tid")&&(o.fields=r.concat(JOIN_TRS_FIELDS),(c={})[this.schema.table+".tid"]="t.id",o.join=[{type:"inner",table:"transactions",alias:"t",on:c}]),d=jsonSql.build(o).query,e.next=13,this.db.query(d);case 13:return f=e.sent,app.logger.debug("Model#findAll",d),e.abrupt("return",this.parseRows(o.fields,f));case 16:case"end":return e.stop()}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"findOne",value:(a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var r,a,n,i,s,l,u,o,c,d=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(r=t.fields||this.allFields).map(function(e){return d.schema.table+"."+e}),a={},Array.isArray(t.condition))for(n in a=t.condition.slice())for(i in a[n])a[n][this.schema.table+"."+i]=a[n][i],delete a[n][i];else if("object"===(0,_typeof3.default)(t.condition))for(s in a=extend({},t.condition))a[this.schema.table+"."+s]=a[s],delete a[s];return a[this.schema.table+"._deleted_"]=0,l={type:"select",table:this.schema.table,fields:r,condition:a},-1!==this.allFields.indexOf("tid")&&(l.fields=r.concat(JOIN_TRS_FIELDS),(u={})[this.schema.table+".tid"]="t.id",l.join=[{type:"inner",table:"transactions",alias:"t",on:u}]),o=jsonSql.build(l).query,e.next=10,this.db.query(o);case 10:if(c=e.sent,app.logger.debug("Model#findOne",o,c),c&&0!==c.length){e.next=14;break}return e.abrupt("return",null);case 14:return e.abrupt("return",this.parseRows(l.fields,c)[0]);case 15:case"end":return e.stop()}},e,this)})),function(e){return a.apply(this,arguments)})},{key:"create",value:function(e){var t=jsonSql.build({type:"insert",table:this.schema.table,values:e}).query;return this.db.query(t)}},{key:"exists",value:(r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var r;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t&&"object"===(void 0===t?"undefined":(0,_typeof3.default)(t))&&(t._deleted_=0),e.next=3,this.count(t);case 3:return r=e.sent,e.abrupt("return",0<r);case 5:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"count",value:(t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var r,a;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t&&"object"===(void 0===t?"undefined":(0,_typeof3.default)(t))&&(t._deleted_=0),r=(r=jsonSql.build({type:"select",table:this.schema.table,fields:["count(*) as count"],condition:t}).query).replace(/"/g,""),e.next=5,this.db.query(r);case 5:return a=e.sent,e.abrupt("return",Number(a[0].count));case 7:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})}]),n}(),Transaction=function(){function t(e){(0,_classCallCheck3.default)(this,t),this.db=e,this.inTransaction=!0}var e,r;return(0,_createClass3.default)(t,[{key:"commit",value:(r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.inTransaction){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.db.query("RELEASE SAVEPOINT tmp");case 5:app.logger.debug("committed"),e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(2),app.logger.error("commit failed",e.t0),e.t0;case 12:return e.prev=12,this.inTransaction=!1,e.finish(12);case 15:case"end":return e.stop()}},e,this,[[2,8,12,15]])})),function(){return r.apply(this,arguments)})},{key:"rollback",value:(e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.inTransaction){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.db.query("ROLLBACK TO SAVEPOINT tmp");case 5:this.inTransaction=!1,app.logger.warn("rollbacked"),e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(2),app.logger.error("rollback failed",e.t0),e.t0;case 13:return e.prev=13,this.inTransaction=!1,e.finish(13);case 16:case"end":return e.stop()}},e,this,[[2,9,13,16]])})),function(){return e.apply(this,arguments)})}]),t}(),Orm=function(){function n(e,t,r,a){(0,_classCallCheck3.default)(this,n),this.options=a,this.dblite=dblite(a.storage)}var e,t;return(0,_createClass3.default)(n,[{key:"define",value:function(e,t){return t.type="create",new Model(t,this)}},{key:"query",value:function(e){return this.dblite.query(e)}},{key:"transaction",value:(t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.query("SAVEPOINT tmp");case 3:return this.inTransaction=!0,app.logger.debug("begin transaction"),e.abrupt("return",new Transaction(this));case 8:throw e.prev=8,e.t0=e.catch(0),app.logger.error("begin transaction failed",e.t0),e.t0;case 12:case"end":return e.stop()}},e,this,[[0,8]])})),function(){return t.apply(this,arguments)})},{key:"close",value:(e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.dblite.close(),e.next=3,PIFY(function(e){setTimeout(e,1e3)})();case 3:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})}]),n}();module.exports=Orm;