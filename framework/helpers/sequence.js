"use strict";var _setImmediate2=require("babel-runtime/core-js/set-immediate"),_setImmediate3=_interopRequireDefault(_setImmediate2);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var util=require("util"),extend=require("extend");function Sequence(e){var t={onWarning:null,warningLimit:300};t=extend(t,e);var n=this;this.sequence=[],this.counter=1,this.name=e.name,(0,_setImmediate3.default)(function e(){t.onWarning&&n.sequence.length>=t.warningLimit&&t.onWarning(n.sequence.length,t.warningLimit),n.__tick(function(){setTimeout(e,3)})})}Sequence.prototype.__tick=function(n){var i=this,u=this.sequence.shift();if(!u)return(0,_setImmediate3.default)(n);var e=[function(e,t){app.logger.debug(i.name+" sequence item finish "+u.counter+" func "+u.name),u.done&&(0,_setImmediate3.default)(u.done,e,t),(0,_setImmediate3.default)(n)}];u.args&&(e=[].concat(e,u.args)),app.logger.debug(i.name+" sequence item call "+u.counter+" func "+u.name),u.worker.apply(u.worker,e)},Sequence.prototype.add=function(e,t,n,i){if(!i&&n&&"function"==typeof n&&(i=n,n=void 0),t&&"function"==typeof t){var u={name:e,worker:t,done:i};util.isArray(n)&&(u.args=n),u.counter=this.counter++,app.logger.debug(this.name+" sequence item in "+u.counter+" func "+e),this.sequence.push(u)}},Sequence.prototype.count=function(){return this.sequence.length},module.exports=Sequence;