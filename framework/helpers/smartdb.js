"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function deconstruct(e){var r=0,t=null;for(var n in e)if(t=[n,e[n]],++r>1)throw new Error("Multi k-v deconstruct not supported");if(!t)throw new Error("Empty condition not supported");return t}function fromMapToToken(e){var r=[];for(var t in e)r.push(t+":"+e[t]);if(!r)throw new Error("Empty condition not supported");return r.join(",")}function fromIndexSchemaToToken(e,r){var t="";if("string"==typeof e){if(!r[e])throw new Error("Empty index not supported: "+e);t=e+":"+r[e]}else{if(!Array.isArray(e))throw new Error("Index format not supported");var n=[];for(var o in e){var a=e[o];if(!r[a])throw new Error("Empty index not supported: "+a);n.push(a+":"+r[a])}t=n.join(",")}return t}function fromModelToTable(e){return changeCase.snakeCase(e)+"s"}function escapeSingleQuote(e){for(var r in e)"string"==typeof e[r]&&(e[r]=e[r].replace(/'/g,"''"))}var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_toArray2=require("babel-runtime/helpers/toArray"),_toArray3=_interopRequireDefault(_toArray2),_map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_set=require("babel-runtime/core-js/set"),_set2=_interopRequireDefault(_set),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),jsonSql=require("json-sql")({separatedValues:!1}),changeCase=require("change-case"),SmartDB=function(){function e(r){(0,_classCallCheck3.default)(this,e),this.app=r,this.trsLogs=new Array,this.blockLogs=new Array,this.lockCache=new _set2.default,this.indexes=new _map2.default,this.indexSchema=new _map2.default}return(0,_createClass3.default)(e,[{key:"undoLogs",value:function(e){for(;e.length>0;){var r=e.pop(),t=(0,_toArray3.default)(r),n=t[0],o=t.slice(1);this["undo"+n].apply(this,o)}}},{key:"beginBlock",value:function(){}},{key:"rollbackBlock",value:function(){this.lockCache.clear(),this.rollbackTransaction(),this.undoLogs(this.blockLogs)}},{key:"commitBlock",value:function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var t,n,o,a,i,s,u,l=this;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=r||{},this.trsLogs.length>0&&this.commitTransaction(),console.log("enter commitBlock"),t=100,n=[],o=[],a=0,this.blockLogs.forEach(function(e){a%t==0&&0!==o.length&&(n.push(o),o=[]);var r=(0,_toArray3.default)(e),i=r[0],s=r.slice(1);"Lock"!==i&&(o.push(l["build"+i].apply(l,s).query),a++)}),0!==o.length&&n.push(o),0!==n.length){e.next=11;break}return e.abrupt("return",!0);case 11:if(console.log("sql batchs size",n.length),e.prev=12,r.noTransaction){e.next=17;break}return e.next=16,this.app.db.transaction();case 16:i=e.sent;case 17:e.t0=_regenerator2.default.keys(n);case 18:if((e.t1=e.t0()).done){e.next=25;break}return s=e.t1.value,u=n[s].join(""),e.next=23,this.app.db.query(u);case 23:e.next=18;break;case 25:if(r.noTransaction){e.next=28;break}return e.next=28,i.commit();case 28:this.blockLogs=new Array,this.lockCache.clear(),e.next=39;break;case 32:if(e.prev=32,e.t2=e.catch(12),console.log("-!!!!!!!!!!!!!!!!!!!!!!commit error",e.t2),r.noTransaction){e.next=38;break}return e.next=38,i.rollback();case 38:throw new Error("Failed to commit block: "+e.t2);case 39:console.log("after commit transaction");case 40:case"end":return e.stop()}},e,this,[[12,32]])}));return function(r){return e.apply(this,arguments)}}()},{key:"beginTransaction",value:function(){}},{key:"rollbackTransaction",value:function(){this.undoLogs(this.trsLogs)}},{key:"commitTransaction",value:function(){this.blockLogs=this.blockLogs.concat(this.trsLogs),this.trsLogs=new Array}},{key:"load",value:function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t,n){var o,a,i;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=this.app,e.next=3,o.model[r].findAll({fields:t});case 3:a=e.sent,i=new _map2.default,a.forEach(function(e){n.forEach(function(r){var n=fromIndexSchemaToToken(r,e);if(void 0!=i.get(n))throw Error("Ununique index not supported: "+n);var o={};t.forEach(function(r){o[r]=e[r]}),i.set(n,o)})}),this.indexes.set(r,i),this.indexSchema.set(r,{fields:t,indexes:n});case 8:case"end":return e.stop()}},e,this)}));return function(r,t,n){return e.apply(this,arguments)}}()},{key:"get",value:function(e,r){if(!e||!r)throw new Error("Invalid params");var t=this.indexes.get(e),n=this.indexSchema.get(e);if(!t||!n)throw new Error("Model not found in cache: "+e);var o=fromMapToToken(r);return t.get(o)||null}},{key:"keys",value:function(e){if(!e)throw new Error("Invalid params");var r=this.indexes.get(e),t=this.indexSchema.get(e);if(!r||!t)throw new Error("Model not found in cache: "+e);return r.keys()}},{key:"entries",value:function(e){if(!e)throw new Error("Invalid params");var r=this.indexes.get(e),t=this.indexSchema.get(e);if(!r||!t)throw new Error("Model not found in cache: "+e);return r.entries()}},{key:"lock",value:function(e){if(this.lockCache.has(e))throw new Error("Key is locked in this block: "+e);this.trsLogs.push(["Lock",e]),this.lockCache.add(e)}},{key:"undoLock",value:function(e){this.lockCache.delete(e)}},{key:"create",value:function(e,r){this.trsLogs.push(["Create",e,r]);var t=this.indexes.get(e),n=this.indexSchema.get(e);if(t&&n){var o={};for(var a in r)-1!==n.fields.indexOf(a)&&(o[a]=r[a]);n.indexes.forEach(function(e){var n=fromIndexSchemaToToken(e,r);if(t.get(n))throw Error("Ununique index not supported: "+n);t.set(n,o)})}}},{key:"undoCreate",value:function(e,r){var t=this.indexes.get(e),n=this.indexSchema.get(e);if(t&&n)for(var o in r)n.indexes.forEach(function(e){var n=fromIndexSchemaToToken(e,r);t.delete(n)})}},{key:"buildCreate",value:function(e,r){escapeSingleQuote(r);var t=fromModelToTable(e);return jsonSql.build({type:"insert",table:t,values:r})}},{key:"replace",value:function(e,r){this.trsLogs.push(["Replace",e,r]);var t=this.indexes.get(e),n=this.indexSchema.get(e);if(t&&n){var o={};for(var a in r)-1!==n.fields.indexOf(a)&&(o[a]=r[a]);if(n.indexes.length>1)throw new Error("Model have more than one index");var i=fromIndexSchemaToToken(n.indexes[0],r),s=t.get(i);s&&this.trsLogs[this.trsLogs.length-1].push(s),t.set(i,r)}}},{key:"undoReplace",value:function(e,r,t){var n=this.indexes.get(e),o=this.indexSchema.get(e);if(n&&o){var a=fromIndexSchemaToToken(o.indexes[0],r);t?n.set(a,t):n.delete(a)}}},{key:"buildReplace",value:function(e,r){escapeSingleQuote(r);var t=fromModelToTable(e);return jsonSql.build({type:"insert",or:"replace",table:t,values:r})}},{key:"update",value:function(e,r,t){if(!e||!r||!t)throw new Error("Invalid params");var n=deconstruct(r);this.trsLogs.push(["Update",e,r,t]);var o=this.indexes.get(e);if(o){var a=fromMapToToken(t),i=o.get(a);i&&(this.trsLogs[this.trsLogs.length-1].push(i[n[0]]),i[n[0]]=n[1])}}},{key:"undoUpdate",value:function(e,r,t,n){var o=this.indexes.get(e);if(o){var a=deconstruct(r),i=fromMapToToken(t),s=o.get(i);if(s){if(!n)throw new Error("Old value should exists");s[a[0]]=n}}}},{key:"buildUpdate",value:function(e,r,t){escapeSingleQuote(r);var n=fromModelToTable(e);return jsonSql.build({type:"update",table:n,modifier:r,condition:t})}},{key:"increment",value:function(e,r,t){if(!e||!r||!t)throw new Error("Invalid params");this.trsLogs.push(["Increment",e,r,t]);var n=this.indexes.get(e);if(n){var o=fromMapToToken(t),a=n.get(o);if(a)for(var i in r)a[i]+=r[i]}}},{key:"undoIncrement",value:function(e,r,t){var n=this.indexes.get(e);if(n){var o=fromMapToToken(t),a=n.get(o);if(a)for(var i in r)a[i]-=r[i]}}},{key:"buildIncrement",value:function(e,r,t){var n=fromModelToTable(e);return jsonSql.build({type:"update",table:n,modifier:{$inc:r},condition:t})}},{key:"del",value:function(e,r){if(!e||!r)throw new Error("Invalid params");var t=deconstruct(r);this.trsLogs.push(["Del",e,r]);var n=this.indexes.get(e);if(n){var o=t.join(":"),a=n.get(o);if(a){this.trsLogs[this.trsLogs.length-1].push(a);var i=this.indexSchema.get(e);for(var s in a)-1!=i.indexes.indexOf(s)&&(o=s+":"+a[s],n.delete(o))}}}},{key:"undoDel",value:function(e,r,t){deconstruct(r);var n=this.indexes.get(e);n&&this.indexSchema.get(e).indexes.forEach(function(e){var r=e+":"+t[e];if(n.get(r))throw Error("Index should have been deleted");n.set(r,t)})}},{key:"buildDel",value:function(e,r){var t=fromModelToTable(e);return jsonSql.build({type:"remove",table:t,condition:r})}}]),e}();module.exports=SmartDB;