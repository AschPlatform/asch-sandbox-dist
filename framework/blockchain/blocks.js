"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function Blocks(e,t){self=this,library=t;try{private_.genesisBlock=require(path.join(app.rootDir,"genesis.json"))}catch(e){return library.logger("Failed to load genesis.json"),void process.exit(3)}private_.lastBlock=private_.genesisBlock,e(null,self)}var _setImmediate2=require("babel-runtime/core-js/set-immediate"),_setImmediate3=_interopRequireDefault(_setImmediate2),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),crypto=require("crypto"),path=require("path"),async=require("async"),extend=require("extend"),bignum=require("bignumber"),slots=require("../helpers/slots.js"),private_={},self=null,library=null,modules=null;private_.lastBlock=null,private_.genesisBlock=null,private_.loaded=!1,private_.blockCache={},private_.proposeCache={},private_.lastPropose=null,private_.lastVoteTime=null,private_.deleteBlock=function(e,t){modules.api.sql.remove({table:"blocks",condition:{id:e}},t)},private_.popLastBlock=function(e,t){if(!e.prevBlockId)return t("Can't remove genesis block");self.getBlock(function(o,r){if(o||!r)return t(o||"Previous block is null");r=self.readDbRows(r);var n=0;async.eachSeries(e.transactions.reverse(),function(e,t){async.series([function(t){n+=e.fee,modules.blockchain.transactions.undo(e,t)},function(t){modules.blockchain.transactions.undoUnconfirmed(e,t)}],t)},function(o){o&&(library.logger(o),process.exit(0)),modules.blockchain.accounts.undoMerging({publicKey:e.delegate,balance:{XAS:n}},function(o){private_.deleteBlock(e.id,function(e){if(e)return t(e);t(null,r[0])})})})},{id:e.prevBlockId})},private_.verify=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var o,r,n,a,s,i,c,l,u;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}return console.log("verify block undefined"),e.abrupt("return");case 3:if(e.prev=3,modules.logic.block.verifyId(t)){e.next=6;break}throw new Error("Invalid block id");case 6:e.next=11;break;case 8:throw e.prev=8,e.t0=e.catch(3),new Error("Failed to verify block id: "+e.t0);case 11:if(e.prev=11,modules.logic.block.verifySignature(t)){e.next=14;break}throw new Error("Invalid block signature");case 14:e.next=19;break;case 16:throw e.prev=16,e.t1=e.catch(11),new Error("Failed to verify signature: "+e.t1);case 19:if(!t.delegates){e.next=21;break}throw new Error("Invalid delegates in block");case 21:if(t.id===private_.genesisBlock.id){e.next=38;break}if(t.prevBlockId==private_.lastBlock.id){e.next=24;break}throw new Error("Invalid previous block");case 24:if(!(t.pointHeight<private_.lastBlock.pointHeight)){e.next=26;break}throw new Error("Invalid point height");case 26:if(!(t.timestamp<=private_.lastBlock.timestamp||t.timestamp>slots.getNow())){e.next=28;break}throw new Error("Invalid timestamp");case 28:return e.next=30,PIFY(modules.api.blocks.getBlock)(t.pointId);case 30:if(o=e.sent){e.next=33;break}throw new Error("Point block not found");case 33:return e.next=35,app.model.Block.exists({pointId:t.pointId});case 35:if(!(r=e.sent)){e.next=38;break}throw new Error("Parent block already pointed");case 38:if(!(t.payloadLength>1048576)){e.next=40;break}throw new Error("Invalid payload length");case 40:if(e.prev=40,32==(n=new Buffer(t.payloadHash,"hex")).length){e.next=44;break}throw new Error("Invalid payload hash");case 44:e.next=49;break;case 46:throw e.prev=46,e.t2=e.catch(40),new Error("Invalid payload hash");case 49:a=crypto.createHash("sha256"),s=0,e.prev=51,e.t3=_regenerator2.default.keys(t.transactions);case 53:if((e.t4=e.t3()).done){e.next=64;break}if(i=e.t4.value,c=t.transactions[i],l=modules.logic.transaction.getBytes(c,!0),a.update(l),s+=l.length,u=modules.logic.transaction.verifyBytes(c.senderPublicKey,c.signature,l)){e.next=62;break}throw new Error("Invalid transaction signature");case 62:e.next=53;break;case 64:e.next=69;break;case 66:throw e.prev=66,e.t5=e.catch(51),new Error("Failed to verify transaction: "+e.t5);case 69:if(a=a.digest(),s==t.payloadLength){e.next=72;break}throw new Error("Payload length is incorrect");case 72:if(a.toString("hex")==t.payloadHash){e.next=74;break}throw new Error("Payload hash is incorrect");case 74:case"end":return e.stop()}},e,this,[[3,8],[11,16],[40,46],[51,66]])}));return function(t){return e.apply(this,arguments)}}(),private_.getIdSequence=function(e,t){var o=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function r(){var n,a;return _regenerator2.default.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.prev=0,o.next=3,app.model.Block.findAll({fields:["id","height"],condition:{height:{$lte:e}},sort:{height:-1},limit:5});case 3:return n=o.sent,a=n.map(function(e){return e.id}),o.abrupt("return",t(null,{ids:a,firstHeight:n[0].height}));case 8:o.prev=8,o.t0=o.catch(0),t(o.t0);case 11:case"end":return o.stop()}},r,o,[[0,8]])}))()},private_.rollbackUntilBlock=function(e,t){modules.api.sql.select({table:"blocks",condition:{pointId:e.pointId,pointHeight:e.pointHeight},fields:["id","height"]},{id:String,height:Number},function(e,o){!e&&o.length?(console.log("Blocks#rollbackUntilBlock",o),self.deleteBlocksBefore(o[0],t)):t()})},private_.verifyVotes=function(e){var t={};modules.blockchain.round.generateDelegateList(e.height).forEach(function(e){t[e]=!0});for(var o=0;o<e.signatures.length;++o){var r=e.signatures[o];if(!t[r.key])return console.log("Votes key is not in the top list: "+r.key),!1;if(!modules.logic.consensus.verifyVote(e.height,e.id,r))return console.log("Failed to verify vote"),!1}return!0},Blocks.prototype.processFee=function(e){if(e&&e.transactions){var t=!0,o=!1,r=void 0;try{for(var n,a=(0,_getIterator3.default)(e.transactions);!(t=(n=a.next()).done);t=!0){var s=n.value,i=app.getFee(s.type)||app.defaultFee;app.feePool.add(i.currency,s.fee)}}catch(e){o=!0,r=e}finally{try{!t&&a.return&&a.return()}finally{if(o)throw r}}}},Blocks.prototype.processBlock=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,o){var r,n;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("ProcessBlock===================",t.id,t.height,o),o.local){e.next=33;break}return e.prev=2,modules.logic.block.normalize(t),e.next=6,private_.verify(t);case 6:if(!o.votes){e.next=16;break}if(r=o.votes,t.height==r.height){e.next=10;break}throw new Error("Votes height is not correct");case 10:if(t.id==r.id){e.next=12;break}throw new Error("Votes id is not correct");case 12:if(r.signatures&&modules.logic.consensus.hasEnoughVotesRemote(r)){e.next=14;break}throw new Error("Votes signature is not enough");case 14:if(private_.verifyVotes(o.votes)){e.next=16;break}throw new Error("Failed to verify votes");case 16:for(n in t.transactions)modules.logic.transaction.normalize(t.transactions[n]);e.next=23;break;case 19:throw e.prev=19,e.t0=e.catch(2),library.logger("Failed to verify block: "+e.t0),e.t0;case 23:return console.log("before applyBlock"),e.prev=24,e.next=27,self.applyBlock(t,o);case 27:e.next=33;break;case 29:throw e.prev=29,e.t1=e.catch(24),library.logger("Failed to apply block: "+e.t1),e.t1;case 33:return e.prev=33,self.processFee(t),self.saveBlock(t),e.next=38,self.applyRound(t);case 38:return e.next=40,app.sdb.commitBlock({noTransaction:!!o.noTransaction});case 40:e.next=47;break;case 42:throw e.prev=42,e.t2=e.catch(33),console.log("save block error: ",e.t2),app.sdb.rollbackBlock(),new Error("Failed to save block: "+e.t2);case 47:console.log("Block applied correctly with "+t.count+" transactions"),self.setLastBlock(t),private_.blockCache={},private_.proposeCache={},private_.lastVoteTime=null,modules.logic.consensus.clearState(),o.broadcast&&modules.api.transport.message("block",{block:t,votes:o.votes});case 54:case"end":return e.stop()}},e,this,[[2,19],[24,29],[33,42]])}));return function(t,o){return e.apply(this,arguments)}}(),Blocks.prototype.applyRound=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var o,r,n,a,s,i;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=app.meta.delegates,t.height%o.length==0){e.next=3;break}return e.abrupt("return");case 3:for(console.log("----------------------on round end-----------------------"),r=new _map2.default,n=new _map2.default,a=app.feePool.getFees(),console.log("fees",a),a.forEach(function(e,t){var a=bignum(e).div(o.length).floor();r.set(t,a.toString());var s=bignum(e).sub(a.mul(o.length));s.gt(0)&&n.set(t,s.toString())}),console.log("distributes",r,n),s=function(e){var t=modules.blockchain.accounts.generateAddressByPublicKey(o[e]);r.forEach(function(e,o){console.log("apply round distributing fee",t,o,e),app.balances.increase(t,o,e)}),e===o.length-1&&n.forEach(function(e,o){app.balances.increase(t,o,e)})},i=0;i<o.length;++i)s(i);case 12:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),Blocks.prototype.setLastBlock=function(e){private_.lastBlock=e;var t=app.meta.delegates.length,o=Math.floor(e.height/t)+(e.height%t>0?1:0);app.feePool.setRound(o)},Blocks.prototype.applyBatchBlock=function(e,t){async.eachSeries(e,function(e,t){modules.blockchain.blocks.applyBlock(e,t)},t)},Blocks.prototype.saveBatchBlock=function(e,t){for(var o=[],r=[],n=0;n<e.length;n++){o.push([e[n].id,e[n].timestamp,e[n].height,e[n].payloadLength,e[n].payloadHash,e[n].prevBlockId,e[n].pointId,e[n].pointHeight,e[n].delegate,e[n].signature,e[n].count]);for(var a=0;a<e[n].transactions.length;a++)r.push([e[n].transactions[a].id,e[n].transactions[a].type,e[n].transactions[a].senderId,e[n].transactions[a].senderPublicKey,e[n].transactions[a].recipientId,e[n].transactions[a].amount,e[n].transactions[a].fee,e[n].transactions[a].timestamp,e[n].transactions[a].signature,e[n].transactions[a].blockId])}modules.api.sql.batch({table:"blocks",fields:["id","timestamp","height","payloadLength","payloadHash","prevBlockId","pointId","pointHeight","delegate","signature","count"],values:o},function(e){if(e)return t(e);modules.api.sql.batch({table:"transactions",fields:["id","type","senderId","senderPublicKey","recipientId","amount","fee","timestamp","signature","blockId"],values:r},t)})},Blocks.prototype.saveBlock=function(e){console.log("Blocks#save height",e.height);for(var t in e.transactions){var o=e.transactions[t];o.height=e.height,app.sdb.create("Transaction",o)}var r={};for(var n in e)"transactions"!==n&&(r[n]=e[n]);app.sdb.create("Block",r),console.log("Blocks#save end")},Blocks.prototype.readDbRows=function(e){for(var t={},o=[],r=0,n=e.length;r<n;r++){var a=modules.logic.block.dbRead(e[r]);if(a){t[a.id]||(o.push(a.id),t[a.id]=a);var s=modules.logic.transaction.dbRead(e[r]);t[a.id].transactions=t[a.id].transactions||{},s&&(t[a.id].transactions[s.id]||(t[a.id].transactions[s.id]=s))}}return t=o.map(function(e){return t[e].transactions=(0,_keys2.default)(t[e].transactions).map(function(o){return t[e].transactions[o]}),t[e]})},Blocks.prototype.deleteBlocksBefore=function(e,t){async.whilst(function(){return!(e.height>=private_.lastBlock.height)},function(e){console.log("Blocks#popLastBlock",private_.lastBlock.height),private_.popLastBlock(private_.lastBlock,function(t,o){t||(private_.lastBlock=o),e(t)})},function(e){(0,_setImmediate3.default)(t,e)})},Blocks.prototype.simpleDeleteAfterBlock=function(e,t){modules.api.sql.remove({table:"blocks",condition:{height:{$gte:e}}},t)},Blocks.prototype.genesisBlock=function(){return private_.genesisBlock},Blocks.prototype.createBlock=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,o,r,n){var a,s,i,c,l,u,p,d,g,h,f,k;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=modules.blockchain.transactions.getUnconfirmedTransactionList(),s=crypto.createHash("sha256"),i=0,e.t0=_regenerator2.default.keys(a);case 4:if((e.t1=e.t0()).done){e.next=14;break}if(c=e.t1.value,l=a[c],u=modules.logic.transaction.getBytes(l,!0),!(i+u.length>8388608)){e.next=10;break}throw new Error("Playload length outof range");case 10:s.update(u),i+=u.length,e.next=4;break;case 14:if(p={delegate:t.publicKey.toString("hex"),height:private_.lastBlock.height+1,prevBlockId:private_.lastBlock.id,pointId:r.id,timestamp:o,pointHeight:r.height,count:a.length,transactions:a,payloadHash:s.digest().toString("hex"),payloadLength:i},d=modules.logic.block.getBytes(p),p.signature=modules.api.crypto.sign(t,d),d=modules.logic.block.getBytes(p),p.id=modules.api.crypto.getId(d),g=modules.blockchain.round.getActiveKeypairs(),console.log("Get active delegate keypairs len: "+g.length),h=modules.logic.consensus.createVotes(g,p),!modules.logic.consensus.hasEnoughVotes(h)){e.next=28;break}return e.next=25,self.processBlock(p,{local:!0,broadcast:!0,votes:h});case 25:console.log("Forged new block id: "+p.id+" height: "+p.height),e.next=42;break;case 28:f="0.0.0.0:0",e.prev=29,k=modules.logic.consensus.createPropose(t,p,f),e.next=37;break;case 33:return e.prev=33,e.t2=e.catch(29),console.log("Failed to create propose: "+e.t2.toString()),e.abrupt("return");case 37:modules.logic.consensus.setPendingBlock(p),modules.logic.consensus.addPendingVotes(h),private_.proposeCache[k.hash]=!0,console.log("Initiate propose on block id: "+p.id+", height: "+p.height),modules.api.transport.message("propose",k);case 42:case"end":return e.stop()}},e,this,[[29,33]])}));return function(t,o,r,n){return e.apply(this,arguments)}}(),Blocks.prototype.applyBlock=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,o){var r,n,a;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r={},e.prev=1,app.sdb.beginBlock(),e.t0=_regenerator2.default.keys(t.transactions);case 4:if((e.t1=e.t0()).done){e.next=15;break}if(n=e.t1.value,a=t.transactions[n],a.senderId=modules.blockchain.accounts.generateAddressByPublicKey(a.senderPublicKey),!r[a.id]){e.next=10;break}throw new Error("Duplicate transaction in block: "+a.id);case 10:return e.next=12,modules.logic.transaction.apply(a,t);case 12:r[a.id]=a,e.next=4;break;case 15:e.next=22;break;case 17:throw e.prev=17,e.t2=e.catch(1),library.logger("apply block error: "+e.t2),app.sdb.rollbackBlock(),new Error("Failed to apply block: "+e.t2);case 22:case"end":return e.stop()}},e,this,[[1,17]])}));return function(t,o){return e.apply(this,arguments)}}(),Blocks.prototype.loadBlocksPeer=function(e,t,o){console.log("Load blocks after:",e),modules.api.transport.getPeer(t,"get","/blocks/after",{lastBlockHeight:e},function(e,t){if(e||!t.body||!t.body.success)return o("Failed to load blocks from peer: "+(e||t.body.error));o(null,t.body.blocks)})},Blocks.prototype.loadBlocksOffset=function(e,t,o){console.log("loadBlocksOffset !!!!!!!!!!")},Blocks.prototype.findCommon=function(e,t){var o=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function r(){var n,a;return _regenerator2.default.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return n=e.query,o.prev=1,o.next=4,app.model.Block.findAll({condition:{id:{$in:n.ids},height:{$between:[n.min,n.max]}},sort:{height:1}});case 4:if((a=o.sent)&&a.length){o.next=7;break}return o.abrupt("return",t("Common block not found"));case 7:return o.abrupt("return",t(null,a[a.length-1]));case 10:return o.prev=10,o.t0=o.catch(1),o.abrupt("return",t("Failed to find common block: "+o.t0));case 13:case"end":return o.stop()}},r,o,[[1,10]])}))()},Blocks.prototype.getCommonBlock=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,o,r){var n,a,s,i,c,l,u;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,e.next=3,PIFY(private_.getIdSequence)(n);case 3:return a=e.sent,console.log("getIdSequence",a),s=n,n=a.firstHeight,i={ids:a.ids,max:s,min:n},e.next=10,PIFY(modules.api.transport.getPeer)(o,"get","/blocks/common",i);case 10:if((c=e.sent).body){e.next=13;break}throw new Error("Failed to find common block");case 13:if(c.body.success){e.next=15;break}throw new Error("Get common block error: "+c.body.error);case 15:return l={id:c.body.id,height:c.body.height},c.body.prevBlockId&&(l.prevBlockId=c.body.prevBlockId),e.next=19,app.model.Block.findOne({condition:l});case 19:if(u=e.sent){e.next=22;break}throw new Error("Failed to find local common block");case 22:return e.abrupt("return",u);case 23:case"end":return e.stop()}},e,this)}));return function(t,o,r){return e.apply(this,arguments)}}(),Blocks.prototype.votes=function(e,t){if(!e.query||!e.query.votes)return t("Invalid params");library.bus.message("votes",e.query.votes),t()},Blocks.prototype.count=function(e,t){modules.api.sql.select({table:"blocks",fields:[{expression:"count(*)",alias:"count"}]},{count:Number},function(e,o){if(e)return t(e);t(e,o[0].count)})},Blocks.prototype.getHeight=function(e,t){t(null,{height:private_.lastBlock.height})},Blocks.prototype.getLastBlock=function(){return private_.lastBlock},Blocks.prototype.getBlock=function(e,t){var o=e.query;modules.api.sql.select(extend({},library.scheme.selector.blocks,{condition:{"b.id":o.id},fields:library.scheme.aliasedFields}),library.scheme.types,t)},Blocks.prototype.getBlocks=function(e,t){var o=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function r(){var n,a;return _regenerator2.default.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.prev=0,o.next=3,app.model.Block.count();case 3:return n=o.sent,o.next=6,app.model.Block.findAll({limit:e.query.limit||100,offset:e.query.offset||0});case 6:return a=o.sent,o.abrupt("return",t(null,{blocks:a,count:n}));case 10:return o.prev=10,o.t0=o.catch(0),o.abrupt("return",t("System error: "+o.t0));case 13:case"end":return o.stop()}},r,o,[[0,10]])}))()},Blocks.prototype.getBlocksAfter=function(e,t){var o=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function r(){var n,a,s,i,c,l,u,p,d,g;return _regenerator2.default.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return n=e.query,a=n.lastBlockHeight,o.next=4,app.model.Block.findAll({condition:{height:{$gt:a}},limit:200,sort:{height:1}});case 4:if((s=o.sent)&&s.length){o.next=7;break}return o.abrupt("return",t(null,{blocks:[]}));case 7:return i=s[s.length-1].height,o.next=10,app.model.Transaction.findAll({condition:{height:{$gt:a,$lte:i}}});case 10:c=o.sent,l=s[0].height;for(u in c)p=c[u],d=p.height,(g=s[d-l])&&(g.transactions||(g.transactions=[]),g.transactions.push(p));t(null,{blocks:s});case 14:case"end":return o.stop()}},r,o)}))()},Blocks.prototype.onMessage=function(e){if("block"==e.topic)library.sequence.add(function(t){var o=this,r=e.message.block,n=e.message.votes;n?r.prevBlockId==private_.lastBlock.id&&r.id!=private_.lastBlock.id&&r.id!=private_.genesisBlock.id&&r.height==private_.lastBlock.height+1?(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var a,s,i;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=!0,e.prev=1,app.sdb.rollbackBlock(),e.next=5,self.processBlock(r,{local:!1,broadcast:!0,votes:n});case 5:e.next=11;break;case 7:e.prev=7,e.t0=e.catch(1),a=!1,library.logger("Blocks#processBlock error",e.t0);case 11:if(a)for(s in r.transactions)modules.blockchain.transactions.removeUnconfirmedTransaction(r.transactions[s].id);return e.prev=12,i=modules.blockchain.transactions.getUnconfirmedTransactionList(),modules.blockchain.transactions.clearUnconfirmed(),e.next=17,modules.blockchain.transactions.receiveTransactionsAsync(i);case 17:e.next=22;break;case 19:e.prev=19,e.t1=e.catch(12),console.log("Failed to redo unconfirmed transactions: "+e.t1);case 22:t();case 23:case"end":return e.stop()}},e,o,[[1,7],[12,19]])}))():(0,_setImmediate3.default)(t):console.log("realtime block consensus must have votes")});else if("propose"==e.topic){var t=e.message;if(private_.proposeCache[t.hash])return;if(private_.proposeCache[t.hash]=!0,private_.lastPropose&&private_.lastPropose.height==t.height&&private_.lastPropose.generatorPublicKey==t.generatorPublicKey&&private_.lastPropose.id!=t.id)return void console.log("generate different block with the same height, generator: "+t.generatorPublicKey);if(t.height!=private_.lastBlock.height+1)return console.log("invalid propose height",t),void(t.height>private_.lastBlock.height+1&&console.log("receive discontinuous propose height "+t.height));if(private_.lastVoteTime&&Date.now()-private_.lastVoteTime<5e3)return void console.log("ignore the frequently propose");if(console.log("receive propose height "+t.height+" bid "+t.id),!modules.blockchain.round.validateProposeSlot(t))return void console.log("Failed to validate propose slot");if(!modules.logic.consensus.acceptPropose(t))return void console.log("Failed to accept propose: ");modules.api.transport.message("propose",t);var o=modules.blockchain.round.getActiveKeypairs();if(console.log("get active keypairs length",o.length),o&&o.length>0){r=modules.logic.consensus.createVotes(o,t);private_.lastVoteTime=Date.now(),private_.lastPropose=t,console.log("send votes height "+r.height+" id "+r.id+" sigatures "+r.signatures.length),modules.api.transport.message("votes",r)}}else if("votes"==e.topic){var r=e.message,n=modules.logic.consensus.getPendingBlock();if(!n||r.height!==n.height||r.id!==n.id)return;library.sequence.add(function(e){var t=modules.logic.consensus.addPendingVotes(r);if(t&&t.signatures&&console.log("receive new votes, total votes number "+t.signatures.length),modules.logic.consensus.hasEnoughVotes(t)){var o=n.height,a=n.id;t.signatures=t.signatures.slice(0,Math.min(6,Math.ceil(2*slots.delegates/3))),(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function r(){return _regenerator2.default.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,self.processBlock(n,{local:!0,broadcast:!0,votes:t});case 3:console.log("Forged new block id: "+a+" height: "+o),r.next=9;break;case 6:r.prev=6,r.t0=r.catch(0),console.log("Failed to process block",{block:n,error:r.t0});case 9:e();case 10:case"end":return r.stop()}},r,this,[[0,6]])}))(),e()}else(0,_setImmediate3.default)(e)})}},Blocks.prototype.onBlockchainLoaded=function(){private_.loaded=!0},Blocks.prototype.onBind=function(e){var t=this;modules=e,(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var o,r;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,PIFY(modules.api.dapps.getDApp)();case 3:return app.meta=e.sent,e.next=6,app.model.Block.count();case 6:if(o=e.sent,console.log("Blocks found:",o),0!==o){e.next=13;break}return e.next=11,self.processBlock(private_.genesisBlock,{});case 11:e.next=17;break;case 13:return e.next=15,app.model.Block.findOne({condition:{height:o}});case 15:r=e.sent,self.setLastBlock(r);case 17:library.bus.message("blockchainLoaded"),e.next=24;break;case 20:e.prev=20,e.t0=e.catch(0),library.logger("Failed to prepare local blockchain",e.t0),process.exit(0);case 24:case"end":return e.stop()}},e,t,[[0,20]])}))()},module.exports=Blocks;