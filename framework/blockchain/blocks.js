"use strict";var _setImmediate2=require("babel-runtime/core-js/set-immediate"),_setImmediate3=_interopRequireDefault(_setImmediate2),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var crypto=require("crypto"),path=require("path"),async=require("async"),extend=require("extend"),bignum=require("bignumber"),slots=require("../helpers/slots.js"),private_={},self=null,library=null,modules=null;function Blocks(e,t){self=this,library=t;try{private_.genesisBlock=require(path.join(app.rootDir,"genesis.json"))}catch(e){return app.logger.error("Failed to load genesis.json"),void library.sandbox.emit("exit")}private_.lastBlock=private_.genesisBlock,e(null,self)}private_.lastBlock=null,private_.genesisBlock=null,private_.loaded=!1,private_.blockCache={},private_.proposeCache={},private_.lastPropose=null,private_.lastVoteTime=null,private_.deleteBlock=function(e,t){modules.api.sql.remove({table:"blocks",condition:{id:e}},t)},private_.verify=function(){var t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var r,o,a,n,s;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(app.logger.trace("enter Blocks#verify"),t){e.next=4;break}return app.logger.error("verify block undefined"),e.abrupt("return");case 4:if(e.prev=4,modules.logic.block.verifyId(t)){e.next=7;break}throw new Error("Invalid block id");case 7:e.next=12;break;case 9:throw e.prev=9,e.t0=e.catch(4),new Error("Failed to verify block id: "+e.t0);case 12:if(e.prev=12,modules.logic.block.verifySignature(t)){e.next=15;break}throw new Error("Invalid block signature");case 15:e.next=20;break;case 17:throw e.prev=17,e.t1=e.catch(12),new Error("Failed to verify signature: "+e.t1);case 20:if(!t.delegates){e.next=22;break}throw new Error("Invalid delegates in block");case 22:if(t.id===private_.genesisBlock.id){e.next=27;break}if(t.prevBlockId==private_.lastBlock.id){e.next=25;break}throw new Error("Invalid previous block");case 25:if(!(t.timestamp<=private_.lastBlock.timestamp||t.timestamp>slots.getNow())){e.next=27;break}throw new Error("Invalid timestamp");case 27:if(!(1048576<t.payloadLength)){e.next=29;break}throw new Error("Invalid payload length");case 29:if(e.prev=29,32==new Buffer(t.payloadHash,"hex").length){e.next=33;break}throw new Error("Invalid payload hash");case 33:e.next=38;break;case 35:throw e.prev=35,e.t2=e.catch(29),new Error("Invalid payload hash");case 38:app.logger.trace("before verify transaction signature"),r=crypto.createHash("sha256"),o=0,e.prev=41,e.t3=_regenerator2.default.keys(t.transactions);case 43:if((e.t4=e.t3()).done){e.next=54;break}if(a=e.t4.value,n=t.transactions[a],s=modules.logic.transaction.getBytes(n,!0),r.update(s),o+=s.length,modules.logic.transaction.verifyBytes(n.senderPublicKey,n.signature,s)){e.next=52;break}throw new Error("Invalid transaction signature");case 52:e.next=43;break;case 54:e.next=59;break;case 56:throw e.prev=56,e.t5=e.catch(41),new Error("Failed to verify transaction: "+e.t5);case 59:if(app.logger.trace("after verify transaction signature"),r=r.digest(),o==t.payloadLength){e.next=63;break}throw new Error("Payload length is incorrect");case 63:if(r.toString("hex")==t.payloadHash){e.next=65;break}throw new Error("Payload hash is incorrect");case 65:case"end":return e.stop()}},e,this,[[4,9],[12,17],[29,35],[41,56]])}));return function(e){return t.apply(this,arguments)}}(),private_.getIdSequence=function(o,a){var n=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var t,r;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,app.model.Block.findAll({fields:["id","height"],condition:{height:{$lte:o}},sort:{height:-1},limit:5});case 3:return t=e.sent,r=t.map(function(e){return e.id}),e.abrupt("return",a(null,{ids:r,firstHeight:t[4].height}));case 8:e.prev=8,e.t0=e.catch(0),a(e.t0);case 11:case"end":return e.stop()}},e,n,[[0,8]])}))()},private_.rollbackUntilBlock=function(e,r){modules.api.sql.select({table:"blocks",condition:{pointId:e.pointId,pointHeight:e.pointHeight},fields:["id","height"]},{id:String,height:Number},function(e,t){!e&&t.length?(app.logger.info("Blocks#rollbackUntilBlock",t),self.deleteBlocksBefore(t[0],r)):r()})},private_.verifyVotes=function(e){app.logger.trace("enter Blocks#verifyVotes");var t=modules.blockchain.round.generateDelegateList(e.height),r={};t.forEach(function(e){r[e]=!0});for(var o=0;o<e.signatures.length;++o){var a=e.signatures[o],n=modules.blockchain.accounts.generateAddressByPublicKey(a.key);if(!r[n])return app.logger.warn("Votes key is not in the top list: "+a.key),!1;if(!modules.logic.consensus.verifyVote(e.height,e.id,a))return app.logger.warn("Failed to verify vote"),!1}return!0},Blocks.prototype.processFee=function(e){if(e&&e.transactions){var t=!0,r=!1,o=void 0;try{for(var a,n=(0,_getIterator3.default)(e.transactions);!(t=(a=n.next()).done);t=!0){var s=a.value,i=app.getFee(s.type)||app.defaultFee;app.feePool.add(i.currency,s.fee)}}catch(e){r=!0,o=e}finally{try{!t&&n.return&&n.return()}finally{if(r)throw o}}}},Blocks.prototype.processBlock=function(){var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,r){var o,a;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(app.logger.debug("processBlock block and options",t,r),r.local){e.next=31;break}if(e.prev=2,modules.logic.block.normalize(t),!r.votes){e.next=14;break}if(o=r.votes,t.height==o.height){e.next=8;break}throw new Error("Votes height is not correct");case 8:if(t.id==o.id){e.next=10;break}throw new Error("Votes id is not correct");case 10:if(o.signatures&&modules.logic.consensus.hasEnoughVotesRemote(o)){e.next=12;break}throw new Error("Votes signature is not enough");case 12:if(private_.verifyVotes(r.votes)){e.next=14;break}throw new Error("Failed to verify votes");case 14:for(a in t.transactions)modules.logic.transaction.normalize(t.transactions[a]);e.next=21;break;case 17:throw e.prev=17,e.t0=e.catch(2),app.logger.error("Failed to verify remote block: "+e.t0),e.t0;case 21:return app.logger.trace("before applyBlock"),e.prev=22,e.next=25,self.applyBlock(t,r);case 25:e.next=31;break;case 27:throw e.prev=27,e.t1=e.catch(22),app.logger.error("Failed to apply remote block: "+e.t1),e.t1;case 31:return e.prev=31,e.next=34,private_.verify(t);case 34:e.next=40;break;case 36:throw e.prev=36,e.t2=e.catch(31),app.logger.error("Failed to verify block: "+e.t2),e.t2;case 40:return e.prev=40,self.processFee(t),self.saveBlock(t),e.next=45,self.applyRound(t);case 45:return e.next=47,app.sdb.commitBlock({noTransaction:!!r.noTransaction});case 47:e.next=54;break;case 49:throw e.prev=49,e.t3=e.catch(40),app.logger.error("save block error: ",e.t3),app.sdb.rollbackBlock(),new Error("Failed to save block: "+e.t3);case 54:app.logger.info("Block applied correctly with "+t.count+" transactions"),self.setLastBlock(t),private_.blockCache={},private_.proposeCache={},private_.lastVoteTime=null,modules.logic.consensus.clearState(),r.broadcast&&modules.api.transport.message("block",{block:t,votes:r.votes});case 61:case"end":return e.stop()}},e,this,[[2,17],[22,27],[31,36],[40,49]])}));return function(e,t){return r.apply(this,arguments)}}(),Blocks.prototype.applyRound=function(){var t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var a,n,s,r,o,i;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=app.meta.delegates,t.height%a.length==0){e.next=3;break}return e.abrupt("return");case 3:for(app.logger.debug("----------------------on round end-----------------------"),app.logger.debug("app.delegate.length",a.length),n=new _map2.default,s=new _map2.default,r=app.feePool.getFees(),app.logger.debug("round fees",r),r.forEach(function(e,t){var r=bignum(e).div(a.length).floor();n.set(t,r.toString());var o=bignum(e).sub(r.mul(a.length));o.gt(0)&&s.set(t,o.toString())}),app.logger.debug("fees distributes",n,s),o=function(e){var r=modules.blockchain.accounts.generateAddressByPublicKey(a[e]);n.forEach(function(e,t){app.logger.debug("apply round distributing fee",r,t,e),app.balances.increase(r,t,e)}),e===a.length-1&&s.forEach(function(e,t){app.logger.debug("apply round distributing fee remain",r,t,e),app.balances.increase(r,t,e)})},i=0;i<a.length;++i)o(i);case 13:case"end":return e.stop()}},e,this)}));return function(e){return t.apply(this,arguments)}}(),Blocks.prototype.setLastBlock=function(e){app.logger.trace("Blocks#setLastBlock",e),private_.lastBlock=e;var t=app.meta.delegates.length,r=Math.floor(e.height/t)+(0<e.height%t?1:0);app.feePool.setRound(r)},Blocks.prototype.applyBatchBlock=function(e,t){async.eachSeries(e,function(e,t){modules.blockchain.blocks.applyBlock(e,t)},t)},Blocks.prototype.saveBatchBlock=function(e,t){for(var r=[],o=[],a=0;a<e.length;a++){r.push([e[a].id,e[a].timestamp,e[a].height,e[a].payloadLength,e[a].payloadHash,e[a].prevBlockId,e[a].pointId,e[a].pointHeight,e[a].delegate,e[a].signature,e[a].count]);for(var n=0;n<e[a].transactions.length;n++)o.push([e[a].transactions[n].id,e[a].transactions[n].type,e[a].transactions[n].senderId,e[a].transactions[n].senderPublicKey,e[a].transactions[n].recipientId,e[a].transactions[n].amount,e[a].transactions[n].fee,e[a].transactions[n].timestamp,e[a].transactions[n].signature,e[a].transactions[n].blockId])}modules.api.sql.batch({table:"blocks",fields:["id","timestamp","height","payloadLength","payloadHash","prevBlockId","pointId","pointHeight","delegate","signature","count"],values:r},function(e){if(e)return t(e);modules.api.sql.batch({table:"transactions",fields:["id","type","senderId","senderPublicKey","recipientId","amount","fee","timestamp","signature","blockId"],values:o},t)})},Blocks.prototype.saveBlock=function(e){for(var t in app.logger.trace("Blocks#save height",e.height),e.transactions){var r=extend({},e.transactions[t]);r.height=e.height,r.args=(0,_stringify2.default)(r.args),app.sdb.create("Transaction",r)}var o={};for(var a in e)"transactions"!==a&&(o[a]=e[a]);app.sdb.create("Block",o),app.logger.trace("Blocks#save end")},Blocks.prototype.readDbRows=function(e){for(var r={},t=[],o=0,a=e.length;o<a;o++){var n=modules.logic.block.dbRead(e[o]);if(n){r[n.id]||(t.push(n.id),r[n.id]=n);var s=modules.logic.transaction.dbRead(e[o]);r[n.id].transactions=r[n.id].transactions||{},s&&(r[n.id].transactions[s.id]||(r[n.id].transactions[s.id]=s))}}return r=t.map(function(t){return r[t].transactions=(0,_keys2.default)(r[t].transactions).map(function(e){return r[t].transactions[e]}),r[t]})},Blocks.prototype.deleteBlocksBefore=function(e,t){async.whilst(function(){return!(e.height>=private_.lastBlock.height)},function(r){app.logger.trace("Blocks#popLastBlock",private_.lastBlock.height),private_.popLastBlock(private_.lastBlock,function(e,t){e||(private_.lastBlock=t),r(e)})},function(e){(0,_setImmediate3.default)(t,e)})},Blocks.prototype.simpleDeleteAfterBlock=function(e,t){modules.api.sql.remove({table:"blocks",condition:{height:{$gte:e}}},t)},Blocks.prototype.genesisBlock=function(){return private_.genesisBlock},Blocks.prototype.createBlock=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,r,o,a){var n,s,i,c,l,p,u,d,g,h,f;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=modules.blockchain.transactions.getUnconfirmedTransactionList(),s=crypto.createHash("sha256"),i=0,e.t0=_regenerator2.default.keys(n);case 4:if((e.t1=e.t0()).done){e.next=14;break}if(c=e.t1.value,l=n[c],p=modules.logic.transaction.getBytes(l,!0),!(8388608<i+p.length)){e.next=10;break}throw new Error("Playload length outof range");case 10:s.update(p),i+=p.length,e.next=4;break;case 14:if(u={delegate:t.publicKey.toString("hex"),height:private_.lastBlock.height+1,prevBlockId:private_.lastBlock.id,pointId:o.id,timestamp:r,pointHeight:o.height,count:n.length,transactions:n,payloadHash:s.digest().toString("hex"),payloadLength:i},d=modules.logic.block.getBytes(u),u.signature=modules.api.crypto.sign(t,d),d=modules.logic.block.getBytes(u),u.id=modules.api.crypto.getId(d),g=modules.blockchain.round.getActiveKeypairs(),app.logger.info("Get active delegate keypairs len: "+g.length),h=modules.logic.consensus.createVotes(g,u),!modules.logic.consensus.hasEnoughVotes(h)){e.next=28;break}return e.next=25,self.processBlock(u,{local:!0,broadcast:!0,votes:h});case 25:app.logger.info("Forged new block id: "+u.id+" height: "+u.height),e.next=42;break;case 28:"0.0.0.0:0",e.prev=29,f=modules.logic.consensus.createPropose(t,u,"0.0.0.0:0"),e.next=37;break;case 33:return e.prev=33,e.t2=e.catch(29),app.logger.error("Failed to create propose: "+e.t2.toString()),e.abrupt("return");case 37:modules.logic.consensus.setPendingBlock(u),modules.logic.consensus.addPendingVotes(h),private_.proposeCache[f.hash]=!0,app.logger.info("Initiate propose on block id: "+u.id+", height: "+u.height),modules.api.transport.message("propose",f);case 42:case"end":return e.stop()}},e,this,[[29,33]])}));return function(e,t,r,o){return a.apply(this,arguments)}}(),Blocks.prototype.applyBlock=function(){var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,r){var o,a,n;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:app.logger.trace("enter applyblock"),o={},e.prev=2,e.t0=_regenerator2.default.keys(t.transactions);case 4:if((e.t1=e.t0()).done){e.next=15;break}if(a=e.t1.value,(n=t.transactions[a]).senderId=modules.blockchain.accounts.generateAddressByPublicKey(n.senderPublicKey),!o[n.id]){e.next=10;break}throw new Error("Duplicate transaction in block: "+n.id);case 10:return e.next=12,modules.logic.transaction.apply(n,t);case 12:o[n.id]=n,e.next=4;break;case 15:e.next=22;break;case 17:throw e.prev=17,e.t2=e.catch(2),app.logger.error(e.t2),app.sdb.rollbackBlock(),new Error("Failed to apply block: "+e.t2);case 22:case"end":return e.stop()}},e,this,[[2,17]])}));return function(e,t){return r.apply(this,arguments)}}(),Blocks.prototype.loadBlocksPeer=function(e,t,r){app.logger.info("Load blocks after:",e),modules.api.transport.getPeer(t,"get","/blocks/after",{lastBlockHeight:e},function(e,t){if(e||!t.blocks||!t.success)return r("Failed to load blocks from peer: "+(e||t.error));r(null,t.blocks)})},Blocks.prototype.loadBlocksOffset=function(e,t,r){app.logger.trace("loadBlocksOffset !!!!!!!!!!")},Blocks.prototype.findCommon=function(o,a){var n=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var t,r;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=o.query,e.prev=1,e.next=4,app.model.Block.findAll({condition:{id:{$in:t.ids},height:{$between:[t.min,t.max]}},sort:{height:1}});case 4:if((r=e.sent)&&r.length){e.next=7;break}return e.abrupt("return",a("Common block not found"));case 7:return e.abrupt("return",a(null,{block:r[r.length-1]}));case 10:return e.prev=10,e.t0=e.catch(1),e.abrupt("return",a("Failed to find common block: "+e.t0));case 13:case"end":return e.stop()}},e,n,[[1,10]])}))()},Blocks.prototype.getCommonBlock=function(){var o=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,r,o){var a,n,s,i,c,l,p;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=t,e.next=3,PIFY(private_.getIdSequence)(a);case 3:return n=e.sent,app.logger.debug("Blocks#getIdSequence",n),s=a,a=n.firstHeight,i={ids:n.ids,max:s,min:a},e.next=10,PIFY(modules.api.transport.getPeer)(r,"get","/blocks/common",i);case 10:if((c=e.sent).success){e.next=13;break}throw new Error("Get common block error: "+c.error);case 13:return l={id:c.block.id,height:c.block.height},c.block.prevBlockId&&(l.prevBlockId=c.block.prevBlockId),e.next=17,app.model.Block.findOne({condition:l});case 17:if(p=e.sent){e.next=20;break}throw new Error("Failed to find local common block");case 20:return e.abrupt("return",p);case 21:case"end":return e.stop()}},e,this)}));return function(e,t,r){return o.apply(this,arguments)}}(),Blocks.prototype.votes=function(e,t){if(!e.query||!e.query.votes)return t("Invalid params");library.bus.message("votes",e.query.votes),t()},Blocks.prototype.getHeight=function(e,t){t(null,{height:private_.lastBlock.height})},Blocks.prototype.getLastBlock=function(){return private_.lastBlock},Blocks.prototype.getBlock=function(e,t){var r=e.query;modules.api.sql.select(extend({},library.scheme.selector.blocks,{condition:{"b.id":r.id},fields:library.scheme.aliasedFields}),library.scheme.types,t)},Blocks.prototype.getBlocks=function(o,a){var n=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var t,r;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,app.model.Block.count();case 3:return t=e.sent,e.next=6,app.model.Block.findAll({limit:o.query.limit||100,offset:o.query.offset||0});case 6:return r=e.sent,e.abrupt("return",a(null,{blocks:r,count:t}));case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",a("System error: "+e.t0));case 13:case"end":return e.stop()}},e,n,[[0,10]])}))()},Blocks.prototype.getBlocksAfter=function(u,d){var g=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var t,r,o,a,n,s,i,c,l,p;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=u.query,r=t.lastBlockHeight,e.next=4,app.model.Block.findAll({condition:{height:{$gt:r}},limit:200,sort:{height:1}});case 4:if((o=e.sent)&&o.length){e.next=7;break}return e.abrupt("return",d(null,{blocks:[]}));case 7:return app.logger.debug("Blocks#getBlocksAfter get blocks",u,o),a=o[o.length-1].height,e.next=11,app.model.Transaction.findAll({condition:{height:{$gt:r,$lte:a}}});case 11:for(i in n=e.sent,app.logger.debug("Blocks#getBlocksAfter get transactions",n),s=o[0].height,n)c=n[i],l=c.height,(p=o[l-s])&&(p.transactions||(p.transactions=[]),p.transactions.push(c));d(null,{blocks:o});case 16:case"end":return e.stop()}},e,g)}))()},Blocks.prototype.onMessage=function(e){if(app.logger.debug("Blocks#onMessage last block = %s, event = %j",private_.lastBlock.id,e),"block"==e.topic)library.sequence.add("Blocks#onMessage#receiveNewBlock",function(a){var n=this,s=e.message.block,i=e.message.votes;if(!i)return app.logger.warn("realtime block consensus must have votes"),a();s.prevBlockId==private_.lastBlock.id&&s.id!=private_.lastBlock.id&&s.id!=private_.genesisBlock.id&&s.height==private_.lastBlock.height+1?(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var t,r,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=!0,e.prev=1,app.sdb.beginBlock(),e.next=5,self.processBlock(s,{local:!1,broadcast:!0,votes:i});case 5:e.next=11;break;case 7:e.prev=7,e.t0=e.catch(1),t=!1,app.logger.error("Blocks#processBlock error",e.t0);case 11:if(t)for(r in s.transactions)modules.blockchain.transactions.removeUnconfirmedTransaction(s.transactions[r].id);return e.prev=12,o=modules.blockchain.transactions.getUnconfirmedTransactionList(),modules.blockchain.transactions.clearUnconfirmed(),e.next=17,modules.blockchain.transactions.receiveTransactionsAsync(o);case 17:e.next=22;break;case 19:e.prev=19,e.t1=e.catch(12),app.logger.error("Failed to redo unconfirmed transactions",e.t1);case 22:a();case 23:case"end":return e.stop()}},e,n,[[1,7],[12,19]])}))():(0,_setImmediate3.default)(a)});else if("propose"==e.topic){var t=e.message;if(private_.proposeCache[t.hash])return;if(private_.proposeCache[t.hash]=!0,private_.lastPropose&&private_.lastPropose.height==t.height&&private_.lastPropose.generatorPublicKey==t.generatorPublicKey&&private_.lastPropose.id!=t.id)return void app.logger.warn("generate different block with the same height, generator: "+t.generatorPublicKey);if(t.height!=private_.lastBlock.height+1)return app.logger.warn("invalid propose height",t),void(t.height>private_.lastBlock.height+1&&app.logger.warn("receive discontinuous propose height "+t.height));if(private_.lastVoteTime&&Date.now()-private_.lastVoteTime<5e3)return void app.logger.warn("ignore the frequently propose");if(app.logger.info("receive propose height "+t.height+" bid "+t.id),!modules.blockchain.round.validateProposeSlot(t))return void app.logger.warn("Failed to validate propose slot");if(!modules.logic.consensus.acceptPropose(t))return void app.logger.warn("Failed to accept propose: ");modules.api.transport.message("propose",t);var r=modules.blockchain.round.getActiveKeypairs();if(app.logger.debug("get active keypairs length",r.length),r&&0<r.length){var n=modules.logic.consensus.createVotes(r,t);private_.lastVoteTime=Date.now(),private_.lastPropose=t,app.logger.info("send votes height "+n.height+" id "+n.id+" sigatures "+n.signatures.length),modules.api.transport.message("votes",n)}}else if("votes"==e.topic){n=e.message;var s=modules.logic.consensus.getPendingBlock();if(!s||n.height!==s.height||n.id!==s.id)return void app.logger.warn("invalid votes message, pending = "+(s?s.height:"null")+", votes = "+n.height+" ");library.sequence.add("Blocks#onMessage#receiveVotes",function(t){var r=modules.logic.consensus.addPendingVotes(n);if(r&&r.signatures&&app.logger.info("receive new votes, total votes number "+r.signatures.length),modules.logic.consensus.hasEnoughVotes(r)){var o=s.height,a=s.id;r.signatures=r.signatures.slice(0,Math.min(6,Math.ceil(2*slots.delegates/3))),(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,self.processBlock(s,{local:!0,broadcast:!0,votes:r});case 3:app.logger.info("Forged new block id: "+a+" height: "+o),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),app.logger.error("Failed to process block",{block:s,error:e.t0});case 9:t();case 10:case"end":return e.stop()}},e,this,[[0,6]])}))()}else(0,_setImmediate3.default)(t)})}},Blocks.prototype.onBlockchainLoaded=function(){private_.loaded=!0},Blocks.prototype.onBind=function(e){var a=this;modules=e,(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var t,r,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,PIFY(modules.api.chains.getChain)();case 3:if(t=e.sent){e.next=6;break}throw new Error("Chain not found");case 6:return app.meta=t,app.logger.info("app.meta",app.meta),e.next=10,app.model.Block.count();case 10:if(r=e.sent,app.logger.info("Blocks found:",r),0!==r){e.next=17;break}return e.next=15,self.processBlock(private_.genesisBlock,{});case 15:e.next=21;break;case 17:return e.next=19,app.model.Block.findOne({condition:{height:r}});case 19:o=e.sent,self.setLastBlock(o);case 21:library.bus.message("blockchainLoaded"),e.next=28;break;case 24:e.prev=24,e.t0=e.catch(0),app.logger.error("Failed to prepare local blockchain",e.t0),library.sandbox.emit("exit");case 28:case"end":return e.stop()}},e,a,[[0,24]])}))()},module.exports=Blocks;