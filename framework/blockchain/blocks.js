"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function Blocks(e,t){self=this,library=t;try{private_.genesisBlock=require(path.join(app.rootDir,"genesis.json"))}catch(e){return library.logger("Failed to load genesis.json"),void process.exit(3)}private_.lastBlock=private_.genesisBlock,e(null,self)}var _setImmediate2=require("babel-runtime/core-js/set-immediate"),_setImmediate3=_interopRequireDefault(_setImmediate2),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),crypto=require("crypto"),path=require("path"),async=require("async"),extend=require("extend"),bignum=require("bignumber"),slots=require("../helpers/slots.js"),private_={},self=null,library=null,modules=null;private_.lastBlock=null,private_.genesisBlock=null,private_.loaded=!1,private_.deleteBlock=function(e,t){modules.api.sql.remove({table:"blocks",condition:{id:e}},t)},private_.popLastBlock=function(e,t){if(!e.prevBlockId)return t("Can't remove genesis block");self.getBlock(function(r,o){if(r||!o)return t(r||"Previous block is null");o=self.readDbRows(o);var n=0;async.eachSeries(e.transactions.reverse(),function(e,t){async.series([function(t){n+=e.fee,modules.blockchain.transactions.undo(e,t)},function(t){modules.blockchain.transactions.undoUnconfirmed(e,t)}],t)},function(r){r&&(library.logger(r),process.exit(0)),modules.blockchain.accounts.undoMerging({publicKey:e.delegate,balance:{XAS:n}},function(r){private_.deleteBlock(e.id,function(e){if(e)return t(e);t(null,o[0])})})})},{id:e.prevBlockId})},private_.verify=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var r,o,n,a,s,c,i,l,u;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}return console.log("verify block undefined"),e.abrupt("return");case 3:if(e.prev=3,modules.logic.block.verifyId(t)){e.next=6;break}throw new Error("Invalid block id");case 6:e.next=11;break;case 8:throw e.prev=8,e.t0=e.catch(3),new Error("Failed to verify block id: "+e.t0);case 11:if(e.prev=11,modules.logic.block.verifySignature(t)){e.next=14;break}throw new Error("Invalid block signature");case 14:e.next=19;break;case 16:throw e.prev=16,e.t1=e.catch(11),new Error("Failed to verify signature: "+e.t1);case 19:if(!t.delegates){e.next=21;break}throw new Error("Invalid delegates in block");case 21:if(t.id===private_.genesisBlock.id){e.next=38;break}if(t.prevBlockId==private_.lastBlock.id){e.next=24;break}throw new Error("Invalid previous block");case 24:if(!(t.pointHeight<private_.lastBlock.pointHeight)){e.next=26;break}throw new Error("Invalid point height");case 26:if(!(t.timestamp<=private_.lastBlock.timestamp||t.timestamp>slots.getNow())){e.next=28;break}throw new Error("Invalid timestamp");case 28:return e.next=30,PIFY(modules.api.blocks.getBlock)(t.pointId);case 30:if(r=e.sent){e.next=33;break}throw new Error("Point block not found");case 33:return e.next=35,app.model.Block.exists({pointId:t.pointId});case 35:if(!(o=e.sent)){e.next=38;break}throw new Error("Parent block already pointed");case 38:if(!(t.payloadLength>1048576)){e.next=40;break}throw new Error("Invalid payload length");case 40:if(e.prev=40,32==(n=new Buffer(t.payloadHash,"hex")).length){e.next=44;break}throw new Error("Invalid payload hash");case 44:e.next=49;break;case 46:throw e.prev=46,e.t2=e.catch(40),new Error("Invalid payload hash");case 49:a=crypto.createHash("sha256"),s=0,e.prev=51,e.t3=_regenerator2.default.keys(t.transactions);case 53:if((e.t4=e.t3()).done){e.next=64;break}if(c=e.t4.value,i=t.transactions[c],l=modules.logic.transaction.getBytes(i,!0),a.update(l),s+=l.length,u=modules.logic.transaction.verifyBytes(i.senderPublicKey,i.signature,l)){e.next=62;break}throw new Error("Invalid transaction signature");case 62:e.next=53;break;case 64:e.next=69;break;case 66:throw e.prev=66,e.t5=e.catch(51),new Error("Failed to verify transaction: "+e.t5);case 69:if(a=a.digest(),s==t.payloadLength){e.next=72;break}throw new Error("Payload length is incorrect");case 72:if(a.toString("hex")==t.payloadHash){e.next=74;break}throw new Error("Payload hash is incorrect");case 74:case"end":return e.stop()}},e,this,[[3,8],[11,16],[40,46],[51,66]])}));return function(t){return e.apply(this,arguments)}}(),private_.getIdSequence=function(e,t){var r=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function o(){var n,a;return _regenerator2.default.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,app.model.Block.findAll({fields:["id","height"],condition:{height:{$lte:e}},sort:{height:-1},limit:5});case 3:return n=r.sent,a=n.map(function(e){return e.id}),r.abrupt("return",t(null,{ids:a,firstHeight:n[0].height}));case 8:r.prev=8,r.t0=r.catch(0),t(r.t0);case 11:case"end":return r.stop()}},o,r,[[0,8]])}))()},private_.rollbackUntilBlock=function(e,t){modules.api.sql.select({table:"blocks",condition:{pointId:e.pointId,pointHeight:e.pointHeight},fields:["id","height"]},{id:String,height:Number},function(e,r){!e&&r.length?(console.log("Blocks#rollbackUntilBlock",r),self.deleteBlocksBefore(r[0],t)):t()})},Blocks.prototype.processFee=function(e){if(e&&e.transactions){var t=!0,r=!1,o=void 0;try{for(var n,a=(0,_getIterator3.default)(e.transactions);!(t=(n=a.next()).done);t=!0){var s=n.value,c=app.getFee(s.type)||app.defaultFee;app.feePool.add(c.currency,s.fee)}}catch(e){r=!0,o=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw o}}}},Blocks.prototype.processBlock=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,r){var o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("ProcessBlock",t.id,t.height),r.local){e.next=23;break}return e.prev=2,modules.logic.block.normalize(t),e.next=6,private_.verify(t);case 6:for(o in t.transactions)modules.logic.transaction.normalize(t.transactions[o]);e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(2),library.logger("Failed to verify block: "+e.t0),e.t0;case 13:return console.log("before applyBlock"),e.prev=14,e.next=17,self.applyBlock(t,r);case 17:e.next=23;break;case 19:throw e.prev=19,e.t1=e.catch(14),library.logger("Failed to apply block: "+e.t1),e.t1;case 23:return e.prev=23,self.processFee(t),self.saveBlock(t),e.next=28,self.applyRound(t);case 28:return e.next=30,app.sdb.commitBlock({noTransaction:!!r.noTransaction});case 30:e.next=37;break;case 32:throw e.prev=32,e.t2=e.catch(23),console.log("save block error: ",e.t2),app.sdb.rollbackBlock(),new Error("Failed to save block: "+e.t2);case 37:r.broadcast&&modules.api.transport.message("block",t),console.log("Block applied correctly with "+t.count+" transactions"),self.setLastBlock(t);case 40:case"end":return e.stop()}},e,this,[[2,9],[14,19],[23,32]])}));return function(t,r){return e.apply(this,arguments)}}(),Blocks.prototype.applyRound=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var r,o,n,a,s,c;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=app.meta.delegates,t.height%r.length==0){e.next=3;break}return e.abrupt("return");case 3:for(console.log("----------------------on round end-----------------------"),o=new _map2.default,n=new _map2.default,a=app.feePool.getFees(),console.log("fees",a),a.forEach(function(e,t){var a=bignum(e).div(r.length).floor();o.set(t,a.toString());var s=bignum(e).sub(a.mul(r.length));s.gt(0)&&n.set(t,s.toString())}),console.log("distributes",o,n),s=function(e){var t=modules.blockchain.accounts.generateAddressByPublicKey(r[e]);o.forEach(function(e,r){console.log("apply round distributing fee",t,r,e),app.balances.increase(t,r,e)}),e===r.length-1&&n.forEach(function(e,r){app.balances.increase(t,r,e)})},c=0;c<r.length;++c)s(c);case 12:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),Blocks.prototype.setLastBlock=function(e){private_.lastBlock=e;var t=app.meta.delegates.length,r=Math.floor(e.height/t)+(e.height%t>0?1:0);app.feePool.setRound(r)},Blocks.prototype.applyBatchBlock=function(e,t){async.eachSeries(e,function(e,t){modules.blockchain.blocks.applyBlock(e,t)},t)},Blocks.prototype.saveBatchBlock=function(e,t){for(var r=[],o=[],n=0;n<e.length;n++){r.push([e[n].id,e[n].timestamp,e[n].height,e[n].payloadLength,e[n].payloadHash,e[n].prevBlockId,e[n].pointId,e[n].pointHeight,e[n].delegate,e[n].signature,e[n].count]);for(var a=0;a<e[n].transactions.length;a++)o.push([e[n].transactions[a].id,e[n].transactions[a].type,e[n].transactions[a].senderId,e[n].transactions[a].senderPublicKey,e[n].transactions[a].recipientId,e[n].transactions[a].amount,e[n].transactions[a].fee,e[n].transactions[a].timestamp,e[n].transactions[a].signature,e[n].transactions[a].blockId])}modules.api.sql.batch({table:"blocks",fields:["id","timestamp","height","payloadLength","payloadHash","prevBlockId","pointId","pointHeight","delegate","signature","count"],values:r},function(e){if(e)return t(e);modules.api.sql.batch({table:"transactions",fields:["id","type","senderId","senderPublicKey","recipientId","amount","fee","timestamp","signature","blockId"],values:o},t)})},Blocks.prototype.saveBlock=function(e){console.log("Blocks#save height",e.height);for(var t in e.transactions){var r=e.transactions[t];r.height=e.height,app.sdb.create("Transaction",r)}var o={};for(var n in e)"transactions"!==n&&(o[n]=e[n]);app.sdb.create("Block",o),console.log("Blocks#save end")},Blocks.prototype.readDbRows=function(e){for(var t={},r=[],o=0,n=e.length;o<n;o++){var a=modules.logic.block.dbRead(e[o]);if(a){t[a.id]||(r.push(a.id),t[a.id]=a);var s=modules.logic.transaction.dbRead(e[o]);t[a.id].transactions=t[a.id].transactions||{},s&&(t[a.id].transactions[s.id]||(t[a.id].transactions[s.id]=s))}}return t=r.map(function(e){return t[e].transactions=(0,_keys2.default)(t[e].transactions).map(function(r){return t[e].transactions[r]}),t[e]})},Blocks.prototype.deleteBlocksBefore=function(e,t){async.whilst(function(){return!(e.height>=private_.lastBlock.height)},function(e){console.log("Blocks#popLastBlock",private_.lastBlock.height),private_.popLastBlock(private_.lastBlock,function(t,r){t||(private_.lastBlock=r),e(t)})},function(e){(0,_setImmediate3.default)(t,e)})},Blocks.prototype.simpleDeleteAfterBlock=function(e,t){modules.api.sql.remove({table:"blocks",condition:{height:{$gte:e}}},t)},Blocks.prototype.genesisBlock=function(){return private_.genesisBlock},Blocks.prototype.createBlock=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,r,o,n){var a,s,c,i,l,u,p,d;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=modules.blockchain.transactions.getUnconfirmedTransactionList(),s=crypto.createHash("sha256"),c=0,e.t0=_regenerator2.default.keys(a);case 4:if((e.t1=e.t0()).done){e.next=14;break}if(i=e.t1.value,l=a[i],u=modules.logic.transaction.getBytes(l,!0),!(c+u.length>8388608)){e.next=10;break}throw new Error("Playload length outof range");case 10:s.update(u),c+=u.length,e.next=4;break;case 14:return p={delegate:t.publicKey.toString("hex"),height:private_.lastBlock.height+1,prevBlockId:private_.lastBlock.id,pointId:o.id,timestamp:r,pointHeight:o.height,count:a.length,transactions:a,payloadHash:s.digest().toString("hex"),payloadLength:c},d=modules.logic.block.getBytes(p),p.signature=modules.api.crypto.sign(t,d),d=modules.logic.block.getBytes(p),p.id=modules.api.crypto.getId(d),e.next=21,self.processBlock(p,{local:!0,broadcast:!0});case 21:case"end":return e.stop()}},e,this)}));return function(t,r,o,n){return e.apply(this,arguments)}}(),Blocks.prototype.applyBlock=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,r){var o,n,a;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o={},e.prev=1,app.sdb.beginBlock(),e.t0=_regenerator2.default.keys(t.transactions);case 4:if((e.t1=e.t0()).done){e.next=15;break}if(n=e.t1.value,a=t.transactions[n],a.senderId=modules.blockchain.accounts.generateAddressByPublicKey(a.senderPublicKey),!o[a.id]){e.next=10;break}throw new Error("Duplicate transaction in block: "+a.id);case 10:return e.next=12,modules.logic.transaction.apply(a,t);case 12:o[a.id]=a,e.next=4;break;case 15:e.next=22;break;case 17:throw e.prev=17,e.t2=e.catch(1),library.logger("apply block error: "+e.t2),app.sdb.rollbackBlock(),new Error("Failed to apply block: "+e.t2);case 22:case"end":return e.stop()}},e,this,[[1,17]])}));return function(t,r){return e.apply(this,arguments)}}(),Blocks.prototype.loadBlocksPeer=function(e,t,r){console.log("Load blocks after:",e),modules.api.transport.getPeer(t,"get","/blocks/after",{lastBlockHeight:e},function(e,t){if(e||!t.body||!t.body.success)return r("Failed to load blocks from peer: "+(e||t.body.error));r(null,t.body.blocks)})},Blocks.prototype.loadBlocksOffset=function(e,t,r){console.log("loadBlocksOffset !!!!!!!!!!")},Blocks.prototype.findCommon=function(e,t){var r=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function o(){var n,a;return _regenerator2.default.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return n=e.query,r.prev=1,r.next=4,app.model.Block.findAll({condition:{id:{$in:n.ids},height:{$between:[n.min,n.max]}},sort:{height:1}});case 4:if(a=r.sent,console.log("findCommon",n,a),a&&a.length){r.next=8;break}return r.abrupt("return",t("Common block not found"));case 8:return r.abrupt("return",t(null,a[a.length-1]));case 11:return r.prev=11,r.t0=r.catch(1),r.abrupt("return",t("Failed to find common block: "+r.t0));case 14:case"end":return r.stop()}},o,r,[[1,11]])}))()},Blocks.prototype.getCommonBlock=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t,r,o){var n,a,s,c,i,l,u;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,e.next=3,PIFY(private_.getIdSequence)(n);case 3:return a=e.sent,console.log("getIdSequence",a),s=n,n=a.firstHeight,c={ids:a.ids,max:s,min:n},e.next=10,PIFY(modules.api.transport.getPeer)(r,"get","/blocks/common",c);case 10:if((i=e.sent).body){e.next=13;break}throw new Error("Failed to find common block");case 13:if(i.body.success){e.next=15;break}throw new Error("Get common block error: "+i.body.error);case 15:return l={id:i.body.id,height:i.body.height},i.body.prevBlockId&&(l.prevBlockId=i.body.prevBlockId),e.next=19,app.model.Block.findOne({condition:l});case 19:if(u=e.sent){e.next=22;break}throw new Error("Failed to find local common block");case 22:return e.abrupt("return",u);case 23:case"end":return e.stop()}},e,this)}));return function(t,r,o){return e.apply(this,arguments)}}(),Blocks.prototype.count=function(e,t){modules.api.sql.select({table:"blocks",fields:[{expression:"count(*)",alias:"count"}]},{count:Number},function(e,r){if(e)return t(e);t(e,r[0].count)})},Blocks.prototype.getHeight=function(e,t){t(null,{height:private_.lastBlock.height})},Blocks.prototype.getLastBlock=function(){return private_.lastBlock},Blocks.prototype.getBlock=function(e,t){var r=e.query;modules.api.sql.select(extend({},library.scheme.selector.blocks,{condition:{"b.id":r.id},fields:library.scheme.aliasedFields}),library.scheme.types,t)},Blocks.prototype.getBlocks=function(e,t){var r=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function o(){var n,a;return _regenerator2.default.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,app.model.Block.count();case 3:return n=r.sent,r.next=6,app.model.Block.findAll({limit:e.query.limit||100,offset:e.query.offset||0});case 6:return a=r.sent,r.abrupt("return",t(null,{blocks:a,count:n}));case 10:return r.prev=10,r.t0=r.catch(0),r.abrupt("return",t("System error: "+r.t0));case 13:case"end":return r.stop()}},o,r,[[0,10]])}))()},Blocks.prototype.getBlocksAfter=function(e,t){var r=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function o(){var n,a,s,c,i,l,u,p,d,f;return _regenerator2.default.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return n=e.query,a=n.lastBlockHeight,r.next=4,app.model.Block.findAll({condition:{height:{$gt:a}},limit:200,sort:{height:1}});case 4:if((s=r.sent)&&s.length){r.next=7;break}return r.abrupt("return",t(null,{blocks:[]}));case 7:return c=s[s.length-1].height,r.next=10,app.model.Transaction.findAll({condition:{height:{$gt:a,$lte:c}}});case 10:i=r.sent,l=s[0].height;for(u in i)p=i[u],d=p.height,(f=s[d-l])&&(f.transactions||(f.transactions=[]),f.transactions.push(p));t(null,{blocks:s});case 14:case"end":return r.stop()}},o,r)}))()},Blocks.prototype.onMessage=function(e){"block"==e.topic&&private_.loaded&&library.sequence.add(function(t){var r=this,o=e.message;o.prevBlockId==private_.lastBlock.id&&o.id!=private_.lastBlock.id&&o.id!=private_.genesisBlock.id&&o.height==private_.lastBlock.height+1?(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var n,a,s;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=!0,e.prev=1,app.sdb.rollbackBlock(),e.next=5,self.processBlock(o,{local:!1,broadcast:!0});case 5:e.next=11;break;case 7:e.prev=7,e.t0=e.catch(1),n=!1,library.logger("Blocks#processBlock error",e.t0);case 11:if(n)for(a in o.transactions)modules.blockchain.transactions.removeUnconfirmedTransaction(o.transactions[a].id);return e.prev=12,s=modules.blockchain.transactions.getUnconfirmedTransactionList(),modules.blockchain.transactions.clearUnconfirmed(),e.next=17,modules.blockchain.transactions.receiveTransactionsAsync(s);case 17:e.next=22;break;case 19:e.prev=19,e.t1=e.catch(12),console.log("Failed to redo unconfirmed transactions: "+e.t1);case 22:t();case 23:case"end":return e.stop()}},e,r,[[1,7],[12,19]])}))():(0,_setImmediate3.default)(t)}),"rollback"==e.topic&&private_.loaded&&library.sequence.add(function(t){var r=e.message;console.log("rollback",r),r.pointHeight<=private_.lastBlock.pointHeight?private_.rollbackUntilBlock(r,function(e){e&&library.logger("Blocks#rollbackUntilBlock error",e),t(e)}):t()})},Blocks.prototype.onBlockchainLoaded=function(){private_.loaded=!0},Blocks.prototype.onBind=function(e){var t=this;modules=e,(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r,o;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,PIFY(modules.api.dapps.getDApp)();case 3:return app.meta=e.sent,e.next=6,app.model.Block.count();case 6:if(r=e.sent,console.log("Blocks found:",r),0!==r){e.next=13;break}return e.next=11,self.processBlock(private_.genesisBlock,{});case 11:e.next=17;break;case 13:return e.next=15,app.model.Block.findOne({condition:{height:r}});case 15:o=e.sent,self.setLastBlock(o);case 17:library.bus.message("blockchainLoaded"),e.next=24;break;case 20:e.prev=20,e.t0=e.catch(0),library.logger("Failed to prepare local blockchain",e.t0),process.exit(0);case 24:case"end":return e.stop()}},e,t,[[0,20]])}))()},module.exports=Blocks;