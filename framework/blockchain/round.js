"use strict";function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function a(n,s){try{var i=t[n](s),o=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(o).then(function(e){a("next",e)},function(e){a("throw",e)});e(o)}return a("next")})}}function Round(e,t){library=t,e(null,self=this)}var _slicedToArray=function(){function e(e,t){var r=[],a=!0,n=!1,s=void 0;try{for(var i,o=e[Symbol.iterator]();!(a=(i=o.next()).done)&&(r.push(i.value),!t||r.length!==t);a=!0);}catch(e){n=!0,s=e}finally{try{!a&&o.return&&o.return()}finally{if(n)throw s}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),async=require("async"),crypto=require("crypto"),AschJS=require("asch-js"),slots=require("../helpers/slots.js"),OutTransferManager=require("../helpers/outtransfer-manager.js"),private_={},self=null,library=null,modules=null;private_.loaded=!1,private_.delegates=[],private_.cacheDelegates={height:0,delegates:[]},private_.keypairs={},private_.outTransferManager=null,private_.signTransaction=function(e,t){return modules.logic.transaction.create(t,e.keypair)},private_.loop=function(e,t){if(!private_.loaded)return library.logger("Loop","exit: syncing"),setImmediate(t);var r=slots.getSlotNumber(),a=modules.blockchain.blocks.getLastBlock();if(r==slots.getSlotNumber(a.timestamp))return setImmediate(t);var n=private_.getState(e.height);if(null===n)return library.logger("Loop","exit: skipping slot"),setImmediate(t);library.sequence.add(function(t){_asyncToGenerator(regeneratorRuntime.mark(function r(){var a,s,i;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(r.prev=0,a=slots.getSlotNumber(n.slotTime),s=slots.getSlotNumber(),a!==s){r.next=16;break}return r.next=6,private_.balanceSync(n.keypair);case 6:return r.next=8,private_.withdrawalSync(n.secret);case 8:if(!app.hooks.beforeCreateBlock){r.next=11;break}return r.next=11,app.hooks.beforeCreateBlock({height:modules.blockchain.blocks.getLastBlock().height+1,pointId:e.id,pointHeight:e.height,slotTime:n.slotTime,signTransaction:private_.signTransaction.bind(null,n),addTransactions:modules.blockchain.transactions.receiveTransactionsAsync});case 11:return r.next=13,modules.blockchain.blocks.createBlock(n.keypair,n.slotTime,e);case 13:i=modules.blockchain.blocks.getLastBlock(),app.events.emit("newBlock",i),library.logger("New dapp block id: "+i.id+" height: "+i.height+" via point: "+i.pointHeight);case 16:r.next=21;break;case 18:r.prev=18,r.t0=r.catch(0),library.logger("Failed to create new block: ",r.t0);case 21:modules.blockchain.transactions.clearUnconfirmed(),t();case 23:case"end":return r.stop()}},r,this,[[0,18]])}))()},t)},private_.balanceSync=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,a,n,s,i,o,c,l,u,p,d,g;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,app.model.Transaction.findAll({condition:{type:1},fields:["args"],sort:{height:-1},limit:1});case 2:return r=e.sent,a=null,r&&r.length&&(a=JSON.parse(r[0].args)[2]),e.next=7,PIFY(modules.api.dapps.getBalanceTransactions)(a);case 7:if((n=e.sent)&&n.length){e.next=10;break}return e.abrupt("return");case 10:s=[],i=!0,o=!1,c=void 0,e.prev=14,l=n[Symbol.iterator]();case 16:if(i=(u=l.next()).done){e.next=25;break}return p=u.value,e.next=20,app.model.Deposit.exists({srcId:p.id});case 20:(d=e.sent)||s.push(p);case 22:i=!0,e.next=16;break;case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(14),o=!0,c=e.t0;case 31:e.prev=31,e.prev=32,!i&&l.return&&l.return();case 34:if(e.prev=34,!o){e.next=37;break}throw c;case 37:return e.finish(34);case 38:return e.finish(31);case 39:return g=s.map(function(e){return modules.logic.transaction.create({type:1,fee:"0",args:JSON.stringify([e.currency,"XAS"===e.currency?e.amount:e.amount2,e.id,modules.blockchain.accounts.generateAddressByPublicKey(e.senderPublicKey)])},t)}),e.next=42,modules.blockchain.transactions.receiveTransactionsAsync(g);case 42:case"end":return e.stop()}},e,this,[[14,27,31,39],[32,,34,38]])}));return function(t){return e.apply(this,arguments)}}(),private_.withdrawalSync=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,a,n,s,i,o,c,l,u,p,d,g,f,h,v,m,y,b,k,_;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(r=private_.outTransferManager.getPending(),a=!0,n=!1,s=void 0,e.prev=4,i=r[Symbol.iterator]();!(a=(o=i.next()).done);a=!0)(c=o.value).signatures.length>=app.meta.unlockDelegates&&(modules.api.dapps.submitOutTransfer(c),private_.outTransferManager.setReady(c.id));e.next=12;break;case 8:e.prev=8,e.t0=e.catch(4),n=!0,s=e.t0;case 12:e.prev=12,e.prev=13,!a&&i.return&&i.return();case 15:if(e.prev=15,!n){e.next=18;break}throw s;case 18:return e.finish(15);case 19:return e.finish(12);case 20:return e.next=22,PIFY(modules.api.dapps.getWithdrawalLastTransaction)();case 22:if(l=e.sent,console.log("get last withdrawal id",l),u=0,!l.id){e.next=31;break}return e.next=28,app.model.Transaction.findOne({condition:{id:l.id},fields:["height","type"]});case 28:p=e.sent,console.log("found last inner withdrawal",p),p?u=p.height:console.log("WARNING last inner withdrawal not found",l.id);case 31:return e.next=33,app.model.Transaction.findAll({condition:{type:2,height:{$gt:u}},fields:["id","senderPublicKey","height","args"],sort:{height:1}});case 33:for(d=e.sent,console.log("found inner withdrawal transactions",d),g=d.filter(function(e){return!private_.outTransferManager.has(e.id)}).map(function(e){var r=JSON.parse(e.args),a=_slicedToArray(r,2),n=a[0],s=a[1],i=modules.blockchain.accounts.generateAddressByPublicKey(e.senderPublicKey),o=AschJS.transfer.createOutTransfer(i,app.meta.transactionId,e.id,n,s,t);o.signatures=[];var c=!0,l=!1,u=void 0;try{for(var p,d=app.config.secrets[Symbol.iterator]();!(c=(p=d.next()).done);c=!0){var g=p.value;if(g!==t&&o.signatures.push(AschJS.transfer.signOutTransfer(o,g)),o.signatures.length>=app.meta.unlockDelegates)break}}catch(e){l=!0,u=e}finally{try{!c&&d.return&&d.return()}finally{if(l)throw u}}return{innerId:e.id,ot:o}}),f=!0,h=!1,v=void 0,e.prev=39,m=g[Symbol.iterator]();!(f=(y=m.next()).done);f=!0)b=y.value,k=b.ot,_=b.innerId,k.signatures.length>=app.meta.unlockDelegates?(modules.api.dapps.submitOutTransfer(k),private_.outTransferManager.addReady(k,_)):(modules.api.transport.message("pendingOutTransfer",k),private_.outTransferManager.addPending(k,_));e.next=47;break;case 43:e.prev=43,e.t1=e.catch(39),h=!0,v=e.t1;case 47:e.prev=47,e.prev=48,!f&&m.return&&m.return();case 50:if(e.prev=50,!h){e.next=53;break}throw v;case 53:return e.finish(50);case 54:return e.finish(47);case 55:private_.outTransferManager.clear();case 56:case"end":return e.stop()}},e,this,[[4,8,12,20],[13,,15,19],[39,43,47,55],[48,,50,54]])}));return function(t){return e.apply(this,arguments)}}(),private_.getState=function(e){for(var t=self.generateDelegateList(e),r=slots.getSlotNumber(),a=slots.getLastSlot(r);r<a;r+=1){var n=t[r%t.length];if(n&&private_.keypairs[n])return{slotTime:slots.getSlotTime(r),keypair:private_.keypairs[n].keypair,secret:private_.keypairs[n].secret}}return null},Round.prototype.getCurrentDelegate=function(e){var t=self.generateDelegateList(e);return t[slots.getSlotNumber()%t.length]},Round.prototype.calc=function(e){return Math.floor(e/private_.delegates.length)+(e%private_.delegates.length>0?1:0)},Round.prototype.generateDelegateList=function(e){if(private_.cacheDelegates.height===e)return private_.cacheDelegates.delegates;for(var t=self.calc(e).toString(),r=private_.delegates.slice(0),a=crypto.createHash("sha256").update(t,"utf8").digest(),n=0,s=r.length;n<s;n++){for(var i=0;i<4&&n<s;n++,i++){var o=a[i]%s,c=r[o];r[o]=r[n],r[n]=c}a=crypto.createHash("sha256").update(a).digest()}return private_.cacheDelegates={height:e,delegates:r},r},Round.prototype.isDelegateAddress=function(e){return-1!==private_.delegates.indexOf(e)},Round.prototype.onBind=function(e){modules=e;for(var t in app.config.secrets){var r=modules.api.crypto.keypair(app.config.secrets[t]),a=modules.blockchain.accounts.generateAddressByPublicKey(r.publicKey);console.log("Forging enable on account: "+a),private_.keypairs[a]={keypair:r,secret:app.config.secrets[t]}}},Round.prototype.onBlockchainLoaded=function(){private_.loaded=!0,private_.delegates=[];for(var e=0;e<app.meta.delegates.length;e++)private_.delegates.push(modules.blockchain.accounts.generateAddressByPublicKey(app.meta.delegates[e])),private_.delegates.sort();slots.setDelegatesNumber(app.meta.delegates.length),private_.outTransferManager=new OutTransferManager(app.meta.unlockDelegates)},Round.prototype.onMessage=function(e){if(private_.loaded)if("point"==e.topic){var t=e.message;private_.loop(t,function(e){e&&library.logger("Loop error",e)})}else if("pendingOutTransfer"==e.topic){var r=e.message;if(!private_.outTransferManager.has(r)){var a=AschJS.transfer.signOutTransfer(out);private_.outTransferManager.addPending(r),private_.outTransferManager.addSignature(r.id,a),modules.api.transport.message("otSignature",{id:r.id,signature:a})}}else if("otSignature"==e.topic){var n=e.message.id,s=e.message.signature;private_.outTransferManager.addSignature(n,s)}else if("withdrawalCompleted"==e.topic){var i=e.message.transactionId;private_.outTransferManager.setReady(i)}},module.exports=Round;