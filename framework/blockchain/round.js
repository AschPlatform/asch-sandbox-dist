"use strict";var _getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_setImmediate2=require("babel-runtime/core-js/set-immediate"),_setImmediate3=_interopRequireDefault(_setImmediate2);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var async=require("async"),crypto=require("crypto"),AschJS=require("asch-js"),slots=require("../helpers/slots.js"),OutTransferManager=require("../helpers/outtransfer-manager.js"),private_={},self=null,library=null,modules=null;function Round(e,t){library=t,e(null,self=this)}private_.loaded=!1,private_.delegates=[],private_.cacheDelegates={height:0,delegates:[]},private_.keypairs={},private_.outTransferManager=null,private_.signTransaction=function(e,t){return modules.logic.transaction.create(t,e.keypair)},private_.loop=function(s,e){if(!private_.loaded)return app.logger.debug("Loop exit: syncing"),(0,_setImmediate3.default)(e);var t=slots.getSlotNumber(),r=modules.blockchain.blocks.getLastBlock();if(t==slots.getSlotNumber(r.timestamp))return(0,_setImmediate3.default)(e);var i=private_.getState(r.height+1);if(null===i)return app.logger.info("Loop exit: skipping slot"),(0,_setImmediate3.default)(e);library.sequence.add("Round#forgeNewBlock",function(n){(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var t,r,a;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=slots.getSlotNumber(i.slotTime),r=slots.getSlotNumber(),t!==r){e.next=15;break}return e.next=6,private_.balanceSync(i.keypair);case 6:return e.next=8,private_.withdrawalSync(i.secret);case 8:if(!app.hooks.beforeCreateBlock){e.next=11;break}return e.next=11,app.hooks.beforeCreateBlock({height:modules.blockchain.blocks.getLastBlock().height+1,pointId:s.id,pointHeight:s.height,slotTime:i.slotTime,signTransaction:private_.signTransaction.bind(null,i),addTransactions:modules.blockchain.transactions.receiveTransactionsAsync});case 11:return e.next=13,modules.blockchain.blocks.createBlock(i.keypair,i.slotTime,s);case 13:a=modules.blockchain.blocks.getLastBlock(),app.logger.info("New dapp block id: "+a.id+" height: "+a.height+" via point: "+a.pointHeight);case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),app.logger.error("Failed to create new block: ",e.t0);case 20:modules.blockchain.transactions.clearUnconfirmed(),n();case 22:case"end":return e.stop()}},e,this,[[0,17]])}))()},e)},private_.balanceSync=function(){var t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var r,a,n,s,i,o,u,c,l,p,g;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return app.logger.debug("enter balanceSync ------------------------"),e.next=3,app.model.Deposit.findAll({sort:{seq:-1},limit:1});case 3:return r=e.sent,app.logger.debug("balanceSync found deposit transactions:",r),a=0,r&&r.length&&(a=r[0].seq),e.next=9,PIFY(modules.api.chains.getDeposits)(a);case 9:if(n=e.sent,app.logger.debug("balanceSync mainTransactions:",n),n&&n.length){e.next=13;break}return e.abrupt("return");case 13:s=[],o=!(i=!0),u=void 0,e.prev=17,c=(0,_getIterator3.default)(n);case 19:if(i=(l=c.next()).done){e.next=28;break}return p=l.value,e.next=23,app.model.Deposit.exists({srcId:p.tid});case 23:e.sent||s.push(p);case 25:i=!0,e.next=19;break;case 28:e.next=34;break;case 30:e.prev=30,e.t0=e.catch(17),o=!0,u=e.t0;case 34:e.prev=34,e.prev=35,!i&&c.return&&c.return();case 37:if(e.prev=37,!o){e.next=40;break}throw u;case 40:return e.finish(37);case 41:return e.finish(34);case 42:return g=s.map(function(e){return modules.logic.transaction.create({type:1,fee:"0",args:[e.currency,e.amount,e.tid,e.senderId,e.seq]},t)}),e.next=45,modules.blockchain.transactions.receiveTransactionsAsync(g);case 45:case"end":return e.stop()}},e,this,[[17,30,34,42],[35,,37,41]])}));return function(e){return t.apply(this,arguments)}}(),private_.withdrawalSync=function(){var t=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(t){var r,a,n,s,i,o,u,c,l,p,g,d,f,h,v,m,_,b,y;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(app.logger.debug("enter withdrawalSync------------------------"),r=private_.outTransferManager.getPending(),n=!(a=!0),s=void 0,e.prev=5,i=(0,_getIterator3.default)(r);!(a=(o=i.next()).done);a=!0)(u=o.value).signatures.length>=app.meta.unlockDelegates&&(modules.api.chains.submitOutTransfer(u),private_.outTransferManager.setReady(u.id));e.next=13;break;case 9:e.prev=9,e.t0=e.catch(5),n=!0,s=e.t0;case 13:e.prev=13,e.prev=14,!a&&i.return&&i.return();case 16:if(e.prev=16,!n){e.next=19;break}throw s;case 19:return e.finish(16);case 20:return e.finish(13);case 21:return e.next=23,PIFY(modules.api.chains.getLastWithdrawal)();case 23:return c=e.sent,app.logger.debug("get last withdrawal on main chain",c),l=0,c&&c.seq&&(l=c.seq),e.next=29,app.model.Withdrawal.findAll({condition:{seq:{$gt:l}},sort:{seq:1}});case 29:for(p=e.sent,app.logger.debug("found inner withdrawal transactions",p),g=p.filter(function(e){return!private_.outTransferManager.has(e.tid)}).map(function(e){var t=e.currency,r=e.amount,a=e.recipientId,n=e.tid,s=e.seq,i=AschJS.transfer.createOutTransfer(app.meta.address,app.meta.name,a,t,r,n,s),o=!0,u=!(i.signatures=[]),c=void 0;try{for(var l,p=(0,_getIterator3.default)(app.config.secrets);!(o=(l=p.next()).done);o=!0){var g=l.value;if(i.signatures.push(AschJS.transfer.signOutTransfer(i,g)),i.signatures.length>=app.meta.unlockNumber)break}}catch(e){u=!0,c=e}finally{try{!o&&p.return&&p.return()}finally{if(u)throw c}}return{innerId:n,ot:i}}),app.logger.trace("----------outerTransactions",g),f=!(d=!0),h=void 0,e.prev=36,v=(0,_getIterator3.default)(g);!(d=(m=v.next()).done);d=!0)_=m.value,b=_.ot,y=_.innerId,app.logger.trace("----------signatures.length",b.signatures.length),b.signatures.length>=app.meta.unlockNumber?(modules.api.chains.submitOutTransfer(b,function(e){e&&app.logger.error("submit out transfer error",e)}),private_.outTransferManager.addReady(b,y)):(modules.api.transport.message("pendingOutTransfer",b),private_.outTransferManager.addPending(b,y));e.next=44;break;case 40:e.prev=40,e.t1=e.catch(36),f=!0,h=e.t1;case 44:e.prev=44,e.prev=45,!d&&v.return&&v.return();case 47:if(e.prev=47,!f){e.next=50;break}throw h;case 50:return e.finish(47);case 51:return e.finish(44);case 52:private_.outTransferManager.clear();case 53:case"end":return e.stop()}},e,this,[[5,9,13,21],[14,,16,20],[36,40,44,52],[45,,47,51]])}));return function(e){return t.apply(this,arguments)}}(),private_.getState=function(e){var t=self.generateDelegateList(e),r=slots.getSlotNumber(),a=t[r%t.length];return a&&private_.keypairs[a]?{slotTime:slots.getSlotTime(r),address:a,keypair:private_.keypairs[a].keypair,secret:private_.keypairs[a].secret}:null},Round.prototype.validateProposeSlot=function(e){var t=self.generateDelegateList(e.height);return t[slots.getSlotNumber(e.timestamp)%t.length]===modules.blockchain.accounts.generateAddressByPublicKey(e.generatorPublicKey)},Round.prototype.getCurrentDelegate=function(e){var t=self.generateDelegateList(e);return t[slots.getSlotNumber()%t.length]},Round.prototype.calc=function(e){return Math.floor(e/private_.delegates.length)+(0<e%private_.delegates.length?1:0)},Round.prototype.getActiveKeypairs=function(){var e=[];for(var t in private_.keypairs)e.push(private_.keypairs[t].keypair);return e},Round.prototype.generateDelegateList=function(e){if(private_.cacheDelegates.height===e)return private_.cacheDelegates.delegates;for(var t=self.calc(e).toString(),r=private_.delegates.slice(0),a=crypto.createHash("sha256").update(t,"utf8").digest(),n=0,s=r.length;n<s;n++){for(var i=0;i<4&&n<s;n++,i++){var o=a[i]%s,u=r[o];r[o]=r[n],r[n]=u}a=crypto.createHash("sha256").update(a).digest()}return private_.cacheDelegates={height:e,delegates:r},r},Round.prototype.getDelegatePublicKeys=function(){return app.meta.delegates},Round.prototype.isDelegateAddress=function(e){return-1!==private_.delegates.indexOf(e)},Round.prototype.onBind=function(e){for(var t in modules=e,app.config.secrets){var r=modules.api.crypto.keypair(app.config.secrets[t]),a=modules.blockchain.accounts.generateAddressByPublicKey(r.publicKey);app.logger.info("Forging enable on account: "+a),private_.keypairs[a]={keypair:r,secret:app.config.secrets[t]}}},Round.prototype.onBlockchainLoaded=function(){private_.loaded=!0,private_.delegates=[];for(var e=0;e<app.meta.delegates.length;e++)private_.delegates.push(modules.blockchain.accounts.generateAddressByPublicKey(app.meta.delegates[e])),private_.delegates.sort();slots.setDelegatesNumber(app.meta.delegates.length),private_.outTransferManager=new OutTransferManager(app.meta.unlockDelegates)},Round.prototype.onMessage=function(e){if(private_.loaded)if("point"==e.topic){var t=e.message;private_.loop(t,function(e){e&&app.logger.error("Loop error",e)})}else if("pendingOutTransfer"==e.topic){var r=e.message;if(!private_.outTransferManager.has(r)){var a=AschJS.transfer.signOutTransfer(out);private_.outTransferManager.addPending(r),private_.outTransferManager.addSignature(r.id,a),modules.api.transport.message("otSignature",{id:r.id,signature:a})}}else if("otSignature"==e.topic){var n=e.message.id,s=e.message.signature;private_.outTransferManager.addSignature(n,s)}else if("withdrawalCompleted"==e.topic){var i=e.message.transactionId;private_.outTransferManager.setReady(i)}},module.exports=Round;