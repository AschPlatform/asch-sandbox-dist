"use strict";var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_setImmediate2=require("babel-runtime/core-js/set-immediate"),_setImmediate3=_interopRequireDefault(_setImmediate2);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var util=require("util"),crypto=require("crypto"),bignum=require("bignumber"),extend=require("extend"),addressHelper=require("../helpers/address.js"),private_={},self=null,library=null,modules=null;function Accounts(e,r){library=r,e(null,self=this)}function reverseDiff(e){for(var r=e.slice(),t=0;t<r.length;t++){var n="-"==r[t][0]?"+":"-";r[t]=n+r[t].slice(1)}return r}function applyDiff(e,r){for(var t=e?e.slice():[],n=0;n<r.length;n++){var a=r[n][0],c=r[n].slice(1);if("+"==a){var u=-1;if((t=t||[])&&(u=t.indexOf(c)),-1!=u)return!1;t.push(c)}if("-"==a){u=-1;if(t&&(u=t.indexOf(c)),-1==u)return!1;t.splice(u,1),t.length||(t=null)}}return t}private_.accounts=[],private_.accountsIndexById={},private_.executor=null,private_.addAccount=function(e,r){e.address||(e.address=self.generateAddressByPublicKey(e.publicKey)),e.balance=e.balance||{},e.u_balance=e.u_balance||{},e.balance.XAS=e.balance.XAS||0,e.u_balance.XAS=e.u_balance.XAS||0,(r||private_).accounts.push(e);var t=(r||private_).accounts.length-1;return(r||private_).accountsIndexById[e.address]=t,e},private_.removeAccount=function(e,r){var t=(r||private_).accountsIndexById[e];delete(r||private_).accountsIndexById[e],(r||private_).accounts[t]=void 0},private_.getAccount=function(e,r){var t=(r||private_).accountsIndexById[e];return(r||private_).accounts[t]},Accounts.prototype.clone=function(e){var r={data:extend(!0,{},private_.accounts),index:extend(!0,{},private_.accountsIndexById)};for(var t in r.data)for(var n in r.data[t].u_balance)r.data[t].u_balance[n]=r.data[t].balance[n]||0;e(null,r)},Accounts.prototype.getExecutor=function(e){var r=app.secret;if(!r)return(0,_setImmediate3.default)(e,"Secret is null");if(private_.executor)return(0,_setImmediate3.default)(e,null,private_.executor);var t=modules.api.crypto.keypair(r),n=self.generateAddressByPublicKey(t.publicKey.toString("hex"));private_.executor={address:n,keypair:t,secret:r},e(null,private_.executor)},Accounts.prototype.generateAddressByPublicKey=function(e){return addressHelper.generateBase58CheckAddress(e)},Accounts.prototype.getAccount=function(e,r,t){var n=e.address;if(e.publicKey&&(n=self.generateAddressByPublicKey(e.publicKey)),!n)return r("Account not found");r(null,private_.getAccount(n,t))},Accounts.prototype.getAccounts=function(e,r){e(null,(r||private_).accounts.filter(function(e){return!!e}))},Accounts.prototype.setAccountAndGet=function(e,r,t){var n=e.address||null;if(null===n){if(!e.publicKey)return r("Missing address or publicKey");n=self.generateAddressByPublicKey(e.publicKey)}var a=private_.getAccount(n,t);a?extend(a,e):a=private_.addAccount(e,t),r(null,a)},Accounts.prototype.mergeAccountAndGet=function(n,e,r){var t=n.address||null;if(null===t){if(!n.publicKey)return e("Missing address or publicKey");t=self.generateAddressByPublicKey(n.publicKey)}var a=private_.getAccount(t,r);if(!a){var c={address:t};n.publicKey&&(c.publicKey=n.publicKey),a=private_.addAccount(c,r)}(0,_keys2.default)(n).forEach(function(e){var r=n[e];if("number"==typeof r)a[e]=(a[e]||0)+r;else if(util.isArray(r))a[e]=applyDiff(a[e],r);else if("object"==(void 0===r?"undefined":(0,_typeof3.default)(r)))for(var t in r)a[e][t]=(a[e][t]||0)+r[t]}),e(null,a)},Accounts.prototype.undoMerging=function(n,e,r){var t=n.address||null;if(null===t){if(!n.publicKey)return e("Missing address or publicKey");t=self.generateAddressByPublicKey(n.publicKey)}var a=private_.getAccount(t,r);if(!a){var c={address:t};n.publicKey&&(c.publicKey=n.publicKey),a=private_.addAccount(c,r)}(0,_keys2.default)(n).forEach(function(e){var r=n[e];if("number"==typeof r)a[e]=(a[e]||0)-r;else if(util.isArray(r))r=reverseDiff(r),a[e]=applyDiff(a[e],r);else if("object"==(void 0===r?"undefined":(0,_typeof3.default)(r)))for(var t in r)a[e][t]=(a[e][t]||0)-r[t]}),e(null,a)},Accounts.prototype.onBind=function(e){modules=e},Accounts.prototype.login=function(e,u){var i=this,s=e.query;if(!s.secret)return u("secret should not be empty");(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r,t,n,a,c;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=modules.api.crypto.keypair(s.secret),t=self.generateAddressByPublicKey(r.publicKey.toString("hex")),e.next=5,app.model.Balance.findAll({condition:{address:t},fields:["currency","balance"]});case 5:return n=e.sent,e.next=8,app.model.Account.findOne({condition:{address:t}});case 8:a=e.sent,c={address:t,publicKey:r.publicKey.toString("hex"),balances:n,extra:a,isDelegate:modules.blockchain.round.isDelegateAddress(t)},u(null,{account:c}),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),u("Server error: "+e.t0);case 16:case"end":return e.stop()}},e,i,[[0,13]])}))()},Accounts.prototype.getBalances=function(n,a){var c=this;if(!n.params||!n.params.address)return a("Address should not be empty");(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r,t;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=n.params.address,e.next=4,app.model.Balance.findAll({condition:{address:r},fields:["currency","balance"]});case 4:t=e.sent,a(null,{balances:t}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),a("Server error: "+e.t0);case 11:case"end":return e.stop()}},e,c,[[0,8]])}))()},Accounts.prototype.getAccount=function(c,u){var i=this;if(!c.params||!c.params.address)return u("Address should not be empty");(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r,t,n,a;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=c.params.address,e.next=4,app.model.Balance.findAll({condition:{address:r},fields:["currency","balance"]});case 4:return t=e.sent,e.next=7,app.model.Account.findOne({condition:{address:r}});case 7:n=e.sent,a={balances:t,extra:n,isDelegate:modules.blockchain.round.isDelegateAddress(r)},u(null,{account:a}),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),u("Server error: "+e.t0);case 15:case"end":return e.stop()}},e,i,[[0,12]])}))()},Accounts.prototype.open2=function(e,r){if(!e.publicKey)return r("publicKey should not be empty");try{if(32!=new Buffer(e.publicKey,"hex").length)return r("publicKey should be hex format")}catch(e){return r("Invalid publicKey")}var t=self.generateAddressByPublicKey(e.publicKey),n=private_.getAccount(t);n?n.publicKey=e.publicKey:n=private_.addAccount({address:t,publicKey:e.publicKey}),r(null,{account:n})},module.exports=Accounts;