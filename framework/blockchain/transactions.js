"use strict";function _asyncToGenerator(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,r){function t(a,o){try{var s=n[a](o),i=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});e(i)}return t("next")})}}function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function Transactions(e,n){library=n,(self=this).pool=new TransactionPool,e(null,self)}var _createClass=function(){function e(e,n){for(var r=0;r<n.length;r++){var t=n[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(n,r,t){return r&&e(n.prototype,r),t&&e(n,t),n}}(),private_={},self=null,library=null,modules=null,TransactionPool=function(){function e(){_classCallCheck(this,e),this.index=new Map,this.unConfirmed=new Array}return _createClass(e,[{key:"add",value:function(e){this.unConfirmed.push(e),this.index.set(e.id,this.unConfirmed.length-1)}},{key:"remove",value:function(e){var n=this.index.get(e);delete this.index[e],this.unConfirmed[n]=null}},{key:"has",value:function(e){var n=this.index.get(e);return void 0!==n&&!!this.unConfirmed[n]}},{key:"getUnconfirmed",value:function(){for(var e=[],n=0;n<this.unConfirmed.length;n++)this.unConfirmed[n]&&e.push(this.unConfirmed[n]);return e}},{key:"clear",value:function(){this.index=new Map,this.unConfirmed=new Array}},{key:"get",value:function(e){var n=this.index.get(e);return this.unConfirmed[n]}}]),e}();Transactions.prototype.getUnconfirmedTransaction=function(e){return self.pool.get(e)},Transactions.prototype.processUnconfirmedTransactionAsync=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var r,t,a,o,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(modules.logic.transaction.normalize(n),r=modules.logic.transaction.getBytes(n),t=modules.api.crypto.getId(r),!n.id){e.next=8;break}if(n.id==t){e.next=6;break}throw new Error("Incorrect trainsaction id");case 6:e.next=9;break;case 8:n.id=t;case 9:if(!self.pool.has(n.id)){e.next=11;break}throw new Error("Transaction already processed");case 11:if(a=modules.logic.transaction.verify(n)){e.next=14;break}throw new Error("Invalid transaction signature");case 14:return e.next=16,app.model.Transaction.exists({id:n.id});case 16:if(!(o=e.sent)){e.next=19;break}throw new Error("Transaction already confirmed");case 19:return n.senderId||(n.senderId=modules.blockchain.accounts.generateAddressByPublicKey(n.senderPublicKey)),s=modules.blockchain.blocks.getLastBlock().height,i={height:s,delegate:modules.blockchain.round.getCurrentDelegate(s)},e.prev=22,e.next=25,modules.logic.transaction.apply(n,i);case 25:e.next=31;break;case 27:throw e.prev=27,e.t0=e.catch(22),app.sdb.rollbackTransaction(),new Error("Apply transaction error: "+e.t0);case 31:return self.pool.add(n),e.abrupt("return",n);case 33:case"end":return e.stop()}},e,this,[[22,27]])}));return function(n){return e.apply(this,arguments)}}(),Transactions.prototype.getUnconfirmedTransactionList=function(){return self.pool.getUnconfirmed()},Transactions.prototype.removeUnconfirmedTransaction=function(e){self.pool.remove(e)},Transactions.prototype.hasUnconfirmed=function(e){return self.pool.has(e)},Transactions.prototype.clearUnconfirmed=function(){self.pool.clear()},Transactions.prototype.addTransaction=function(e,n){var r=e.query;library.sequence.add(function(e){_asyncToGenerator(regeneratorRuntime.mark(function n(){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,self.processUnconfirmedTransactionAsync(r.transaction);case 3:t=n.sent,e(null,{transactionId:t.id}),n.next=10;break;case 7:n.prev=7,n.t0=n.catch(0),e(n.t0.toString());case 10:case"end":return n.stop()}},n,this,[[0,7]])}))()},n)},Transactions.prototype.addTransactionUnsigned=function(e,n){var r=e.query;if(r.type&&(r.type=Number(r.type)),!library.validator.validate(r,{type:"object",properties:{secret:{type:"string",maxLength:100},fee:{type:"string",maxLength:50},type:{type:"integer",min:1},args:{type:"string"}},required:["secret","fee","type"]}))return setImmediate(n,library.validator.getLastError().details[0].message);library.sequence.add(function(e){_asyncToGenerator(regeneratorRuntime.mark(function n(){var t,a;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,t=modules.api.crypto.keypair(r.secret),a=modules.logic.transaction.create(r,t),n.next=5,self.processUnconfirmedTransactionAsync(a);case 5:e(null,{transactionId:a.id}),n.next=11;break;case 8:n.prev=8,n.t0=n.catch(0),e(n.t0.toString());case 11:case"end":return n.stop()}},n,this,[[0,8]])}))()},n)},Transactions.prototype.getUnconfirmedTransactions=function(e,n){setImmediate(n,null,{transactions:self.getUnconfirmedTransactionList()})},Transactions.prototype.getTransactions=function(e,n){var r=this;_asyncToGenerator(regeneratorRuntime.mark(function t(){var a,o;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,app.model.Transaction.count();case 3:return a=r.sent,r.next=6,app.model.Transaction.findAll({limit:Number(e.query.limit)||100,offset:Number(e.query.offset)||0});case 6:return(o=r.sent)||(o=[]),r.abrupt("return",n(null,{transactions:o,count:a}));case 11:return r.prev=11,r.t0=r.catch(0),console.log("Failed to get transactions",r.t0),r.abrupt("return",n("System error: "+r.t0));case 15:case"end":return r.stop()}},t,r,[[0,11]])}))()},Transactions.prototype.getTransaction=function(e,n){_asyncToGenerator(regeneratorRuntime.mark(function r(){var t,a;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(r.prev=0,e.params&&e.params.id){r.next=3;break}return r.abrupt("return",n("Invalid transaction id"));case 3:return t=e.params.id,r.next=6,app.model.Transaction.findOne({condition:{id:t}});case 6:if(a=r.sent){r.next=9;break}return r.abrupt("return",n("Transaction not found"));case 9:return r.abrupt("return",n(null,{transaction:a}));case 12:return r.prev=12,r.t0=r.catch(0),r.abrupt("return",n("System error: "+r.t0));case 15:case"end":return r.stop()}},r,this,[[0,12]])}))()},Transactions.prototype.receiveTransactions=function(e,n){_asyncToGenerator(regeneratorRuntime.mark(function r(){var t;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:r.prev=0,t=0;case 2:if(!(t<e.length)){r.next=8;break}return r.next=5,self.processUnconfirmedTransactionAsync(e[t]);case 5:++t,r.next=2;break;case 8:r.next=13;break;case 10:return r.prev=10,r.t0=r.catch(0),r.abrupt("return",n(r.t0));case 13:n();case 14:case"end":return r.stop()}},r,this,[[0,10]])}))()},Transactions.prototype.receiveTransactionsAsync=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=0;case 1:if(!(r<n.length)){e.next=7;break}return e.next=4,self.processUnconfirmedTransactionAsync(n[r]);case 4:++r,e.next=1;break;case 7:case"end":return e.stop()}},e,this)}));return function(n){return e.apply(this,arguments)}}(),Transactions.prototype.onMessage=function(e){switch(e.topic){case"transaction":library.sequence.add(function(n){var r=e.message;self.receiveTransactions([r],function(e){e&&console.log("Failed to process transactions: "+e)})})}},Transactions.prototype.onBind=function(e){modules=e},module.exports=Transactions;