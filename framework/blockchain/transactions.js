"use strict";var _setImmediate2=require("babel-runtime/core-js/set-immediate"),_setImmediate3=_interopRequireDefault(_setImmediate2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_map=require("babel-runtime/core-js/map"),_map2=_interopRequireDefault(_map),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var private_={},self=null,library=null,modules=null,TransactionPool=function(){function e(){(0,_classCallCheck3.default)(this,e),this.index=new _map2.default,this.unConfirmed=new Array}return(0,_createClass3.default)(e,[{key:"add",value:function(e){this.unConfirmed.push(e),this.index.set(e.id,this.unConfirmed.length-1)}},{key:"remove",value:function(e){var r=this.index.get(e);delete this.index[e],this.unConfirmed[r]=null}},{key:"has",value:function(e){var r=this.index.get(e);return void 0!==r&&!!this.unConfirmed[r]}},{key:"getUnconfirmed",value:function(){for(var e=[],r=0;r<this.unConfirmed.length;r++)this.unConfirmed[r]&&e.push(this.unConfirmed[r]);return e}},{key:"clear",value:function(){this.index=new _map2.default,this.unConfirmed=new Array}},{key:"get",value:function(e){var r=this.index.get(e);return this.unConfirmed[r]}}]),e}();function Transactions(e,r){library=r,(self=this).pool=new TransactionPool,e(null,self)}Transactions.prototype.getUnconfirmedTransaction=function(e){return self.pool.get(e)},Transactions.prototype.processUnconfirmedTransactionAsync=function(){var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var n,t,a,s;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(modules.logic.transaction.normalize(r),n=modules.logic.transaction.getBytes(r),t=modules.api.crypto.getId(n),!r.id){e.next=8;break}if(r.id==t){e.next=6;break}throw new Error("Incorrect trainsaction id");case 6:e.next=9;break;case 8:r.id=t;case 9:if(app.logger.debug("process unconfirmed trs",r.id),!self.pool.has(r.id)){e.next=12;break}throw new Error("Transaction already processed");case 12:if(modules.logic.transaction.verify(r)){e.next=15;break}throw new Error("Invalid transaction signature");case 15:return e.next=17,app.model.Transaction.exists({id:r.id});case 17:if(!e.sent){e.next=20;break}throw new Error("Transaction already confirmed");case 20:return r.senderId||(r.senderId=modules.blockchain.accounts.generateAddressByPublicKey(r.senderPublicKey)),a=modules.blockchain.blocks.getLastBlock().height,s={height:a,delegate:modules.blockchain.round.getCurrentDelegate(a)},e.prev=23,e.next=26,modules.logic.transaction.apply(r,s);case 26:e.next=32;break;case 28:throw e.prev=28,e.t0=e.catch(23),app.sdb.rollbackTransaction(),new Error("Apply transaction error: "+e.t0);case 32:return self.pool.add(r),e.abrupt("return",r);case 34:case"end":return e.stop()}},e,this,[[23,28]])}));return function(e){return r.apply(this,arguments)}}(),Transactions.prototype.getUnconfirmedTransactionList=function(){return self.pool.getUnconfirmed()},Transactions.prototype.removeUnconfirmedTransaction=function(e){self.pool.remove(e)},Transactions.prototype.hasUnconfirmed=function(e){return self.pool.has(e)},Transactions.prototype.clearUnconfirmed=function(){self.pool.clear()},Transactions.prototype.addTransaction=function(e,r){var t=e.query;library.sequence.add("Transactions#addTransaction",function(n){(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,self.ensureTransactionAcceptable(),e.next=4,self.processUnconfirmedTransactionAsync(t.transaction);case 4:r=e.sent,n(null,{transactionId:r.id}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),n(e.t0.toString());case 11:case"end":return e.stop()}},e,this,[[0,8]])}))()},r)},Transactions.prototype.addTransactionUnsigned=function(e,r){var a=e.query;if(a.type&&(a.type=Number(a.type)),!library.validator.validate(a,{type:"object",properties:{secret:{type:"string",maxLength:100},fee:{type:"string",maxLength:50},type:{type:"integer",min:1}},required:["secret","fee","type"]}))return(0,_setImmediate3.default)(r,library.validator.getLastError().details[0].message);library.sequence.add("Transactions#addTransactionUnsigned",function(t){(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r,n;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,self.ensureTransactionAcceptable(),a.args&&"string"==typeof a.args&&(a.args=JSON.parse(a.args)),r=modules.api.crypto.keypair(a.secret),n=modules.logic.transaction.create(a,r),e.next=7,self.processUnconfirmedTransactionAsync(n);case 7:t(null,{transactionId:n.id}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),t(e.t0.toString());case 13:case"end":return e.stop()}},e,this,[[0,10]])}))()},r)},Transactions.prototype.ensureTransactionAcceptable=function(){if(modules.logic.consensus.pendingBlock)throw new Error("block is pending")},Transactions.prototype.getUnconfirmedTransactions=function(e,r){(0,_setImmediate3.default)(r,null,{transactions:self.getUnconfirmedTransactionList()})},Transactions.prototype.getTransactions=function(e,t){var a=this,s=Number(e.query.limit)||100,o=Number(e.query.offset)||0,i={};e.query.senderId&&(i.senderId=e.query.senderId),e.query.type&&(i.type=Number(e.query.type)),(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r,n;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,app.model.Transaction.count(i);case 3:return r=e.sent,e.next=6,app.model.Transaction.findAll({condition:i,limit:s,offset:o});case 6:return(n=e.sent)||(n=[]),e.abrupt("return",t(null,{transactions:n,count:r}));case 11:return e.prev=11,e.t0=e.catch(0),app.logger.error("Failed to get transactions",e.t0),e.abrupt("return",t("System error: "+e.t0));case 15:case"end":return e.stop()}},e,a,[[0,11]])}))()},Transactions.prototype.getTransaction=function(t,a){(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r,n;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t.params&&t.params.id){e.next=3;break}return e.abrupt("return",a("Invalid transaction id"));case 3:return r=t.params.id,e.next=6,app.model.Transaction.findOne({condition:{id:r}});case 6:if(n=e.sent){e.next=9;break}return e.abrupt("return",a("Transaction not found"));case 9:return e.abrupt("return",a(null,{transaction:n}));case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",a("System error: "+e.t0));case 15:case"end":return e.stop()}},e,this,[[0,12]])}))()},Transactions.prototype.receiveTransactions=function(n,t){(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,r=0;case 2:if(!(r<n.length)){e.next=8;break}return e.next=5,self.processUnconfirmedTransactionAsync(n[r]);case 5:++r,e.next=2;break;case 8:e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(0),e.abrupt("return",t(e.t0));case 13:t();case 14:case"end":return e.stop()}},e,this,[[0,10]])}))()},Transactions.prototype.receiveTransactionsAsync=function(){var r=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r){var n;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=0;case 1:if(!(n<r.length)){e.next=7;break}return e.next=4,self.processUnconfirmedTransactionAsync(r[n]);case 4:++n,e.next=1;break;case 7:case"end":return e.stop()}},e,this)}));return function(e){return r.apply(this,arguments)}}(),Transactions.prototype.onMessage=function(n){switch(n.topic){case"transaction":library.sequence.add("Transactions#onMessage#transaction",function(r){var e=n.message;self.receiveTransactions([e],function(e){e&&app.logger.error("Failed to process transactions: ",e),r()})})}},Transactions.prototype.onBind=function(e){modules=e},module.exports=Transactions;