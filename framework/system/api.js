"use strict";function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(a,o){try{var i=r[a](o),s=i.value}catch(e){return void t(e)}if(!i.done)return Promise.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}return n("next")})}}function Api(e,r){library=r,e(null,self=this)}var private_={},self=null,library=null,modules=null;private_.apies={},private_.appApiHandlers={},private_.loaded=!1,private_.ns=function(e,r){var t,n;t=e[(n=r.split("."))[0]];for(var a=0;a<n.length&&(n=n.slice(1),t=t[n[0]]);a++);return t},private_.applyApiHandler=function(e,r,t){var n=this;_asyncToGenerator(regeneratorRuntime.mark(function a(){var o;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,e(r);case 3:o=n.sent,t(null,{response:o}),n.next=10;break;case 7:n.prev=7,n.t0=n.catch(0),t(n.t0.toString());case 10:case"end":return n.stop()}},a,n,[[0,7]])}))()},Api.prototype.onBind=function(e){modules=e},Api.prototype.onBlockchainLoaded=function(){private_.loaded=!0;try{var e=require("../routes.json")}catch(e){library.logger("Failed to load routes.json"),process.exit(4)}e.forEach(function(e){private_.apies[e.method+" "+e.path]=private_.ns(modules,e.handler)});var r=app.route.getRoutes(),t=!0,n=!1,a=void 0;try{for(var o,i=r[Symbol.iterator]();!(t=(o=i.next()).done);t=!0){var s=o.value;private_.appApiHandlers[s.method+" "+s.path]=s.handler}}catch(e){n=!0,a=e}finally{try{!t&&i.return&&i.return()}finally{if(n)throw a}}_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,a,o,i,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,t=!0,n=!1,a=void 0,e.prev=4,o=r[Symbol.iterator]();case 6:if(t=(i=o.next()).done){e.next=14;break}return s=i.value,console.log("register app interface",s.method,s.path),e.next=11,PIFY(modules.api.dapps.registerInterface)(s);case 11:t=!0,e.next=6;break;case 14:e.next=20;break;case 16:e.prev=16,e.t0=e.catch(4),n=!0,a=e.t0;case 20:e.prev=20,e.prev=21,!t&&o.return&&o.return();case 23:if(e.prev=23,!n){e.next=26;break}throw a;case 26:return e.finish(23);case 27:return e.finish(20);case 28:e.next=35;break;case 30:return e.prev=30,e.t1=e.catch(0),console.log("Failed to register dapp interface",e.t1),process.exit(5),e.abrupt("return");case 35:case"end":return e.stop()}},e,this,[[0,30],[4,16,20,28],[21,,23,27]])}))(),library.sandbox.onMessage(function(e,r,t){var n=private_.apies[e.method+" "+e.path];if(n)n(e.query,function(e,r){e&&(e=e.toString()),t(e,{response:r})});else{if(!(n=private_.appApiHandlers[e.method+" "+e.path]))return t("API call not found");private_.applyApiHandler(n,e.query,t)}}),modules.api.dapps.setReady(function(e){e?console.log("app set ready failed: "+e):console.log("app set ready success")})},Api.prototype.message=function(e,r){library.bus.message("message",e.query),r(null,{})},module.exports=Api;