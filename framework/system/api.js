"use strict";var _getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var private_={},self=null,library=null,modules=null;function Api(e,r){library=r,e(null,self=this)}private_.apies={},private_.appApiHandlers={},private_.loaded=!1,private_.ns=function(e,r){var t,a;t=e[(a=r.split("."))[0]];for(var n=0;n<a.length&&(t=t[(a=a.slice(1))[0]]);n++);return t},private_.applyApiHandler=function(t,a,n){var o=this;(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,app.route.filter&&!app.route.filter(a)&&n("request is rejected"),e.next=4,t(a);case 4:r=e.sent,n(null,{response:r}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),n(e.t0.toString());case 11:case"end":return e.stop()}},e,o,[[0,8]])}))()},Api.prototype.onBind=function(e){modules=e},Api.prototype.onBlockchainLoaded=function(){private_.loaded=!0;try{var e=require("../routes.json")}catch(e){return app.logger.error("Failed to load routes.json"),void library.sandbox.emit("exit")}e.forEach(function(e){private_.apies[e.method+" "+e.path]=private_.ns(modules,e.handler)});var p=app.route.getRoutes(),r=!0,t=!1,a=void 0;try{for(var n,o=(0,_getIterator3.default)(p);!(r=(n=o.next()).done);r=!0){var i=n.value;private_.appApiHandlers[i.method+" "+i.path]=i.handler}}catch(e){t=!0,a=e}finally{try{!r&&o.return&&o.return()}finally{if(t)throw a}}(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r,t,a,n,o,i;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,t=!(r=!0),a=void 0,e.prev=4,n=(0,_getIterator3.default)(p);case 6:if(r=(o=n.next()).done){e.next=14;break}return i=o.value,app.logger.info("register app interface",i.method,i.path),e.next=11,PIFY(modules.api.chains.registerInterface)(i);case 11:r=!0,e.next=6;break;case 14:e.next=20;break;case 16:e.prev=16,e.t0=e.catch(4),t=!0,a=e.t0;case 20:e.prev=20,e.prev=21,!r&&n.return&&n.return();case 23:if(e.prev=23,!t){e.next=26;break}throw a;case 26:return e.finish(23);case 27:return e.finish(20);case 28:e.next=35;break;case 30:return e.prev=30,e.t1=e.catch(0),app.logger.error("Failed to register dapp interface",e.t1),library.sandbox.emit("exit"),e.abrupt("return");case 35:case"end":return e.stop()}},e,this,[[0,30],[4,16,20,28],[21,,23,27]])}))(),library.sandbox.onMessage(function(e,r,t){var a=private_.apies[e.method+" "+e.path];if(a)a(e.query,function(e,r){e&&(e=e.toString()),t(e,{response:r})});else{if(!(a=private_.appApiHandlers[e.method+" "+e.path]))return t("API call not found");private_.applyApiHandler(a,e.query,t)}}),modules.api.chains.setReady(function(e){e?app.logger.error("app set ready failed: "+e):app.logger.info("app set ready success")})},Api.prototype.message=function(e,r){library.bus.message("message",e.query),r(null,{})},module.exports=Api;