"use strict";function _asyncToGenerator(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,t){function o(r,c){try{var i=n[r](c),a=i.value}catch(e){return void t(e)}if(!i.done)return Promise.resolve(a).then(function(e){o("next",e)},function(e){o("throw",e)});e(a)}return o("next")})}}function Sync(e,n){library=n,e(null,self=this)}var bignum=require("bignumber"),async=require("async"),ip=require("ip"),private_={},self=null,library=null,modules=null;private_.createSandbox=function(e,n){modules.blockchain.accounts.clone(function(t,o){var r={lastBlock:e,accounts:o.data,accountsIndexById:o.index,unconfirmedTransactions:[],unconfirmedTransactionsIdIndex:{},doubleSpendingTransactions:{}};n(null,r)})},private_.findUpdate=function(e,n,t){var o=this;_asyncToGenerator(regeneratorRuntime.mark(function r(){var c,i,a,s,u;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.prev=0,o.next=3,modules.blockchain.blocks.getCommonBlock(e.height,n);case 3:if(c=o.sent,console.log("Get common block",c.height,c.id),c.height===e.height){o.next=7;break}return o.abrupt("return",t("Reject fork chain"));case 7:return o.next=10,PIFY(modules.blockchain.blocks.loadBlocksPeer)(e.height,n);case 10:return i=o.sent,console.log("Loading "+i.length+" blocks"),o.next=14,app.db.transaction();case 14:a=o.sent,o.prev=15,o.t0=regeneratorRuntime.keys(i);case 17:if((o.t1=o.t0()).done){o.next=25;break}if(s=o.t1.value,!((u=i[s]).height>e.height)){o.next=23;break}return o.next=23,modules.blockchain.blocks.processBlock(u,{noTransaction:!0});case 23:o.next=17;break;case 25:return o.next=27,a.commit();case 27:o.next=34;break;case 29:return o.prev=29,o.t2=o.catch(15),o.next=33,a.rollback();case 33:throw o.t2;case 34:if(!(i.length<10)){o.next=36;break}return o.abrupt("break",39);case 36:e=modules.blockchain.blocks.getLastBlock(),o.next=7;break;case 39:return console.log("Sync blocks completed"),o.abrupt("return",t());case 43:return o.prev=43,o.t3=o.catch(0),o.abrupt("return",t("Failed to sync blocks: "+o.t3));case 46:case"end":return o.stop()}},r,o,[[0,43],[15,29]])}))()},private_.transactionsSync=function(e){modules.api.transport.getRandomPeer("get","/transactions/unconfirmed",{limit:100},function(n,t){if(n||!t.body||!t.body.success)return e(n||t.body.error);if(!t.body.transactions||!t.body.transactions.length)return e();var o=t.body.transactions.filter(function(e){return!modules.blockchain.transactions.hasUnconfirmed(e.id)});modules.blockchain.transactions.receiveTransactions(o,e)})},private_.blockSync=function(e){modules.api.blocks.getHeight(function(n,t){if(n)return e("Failed to get main block height: "+n);console.log("get main block height",t);var o=modules.blockchain.blocks.getLastBlock();if(o.pointHeight&&t-o.pointHeight<=2)return e();modules.api.transport.getRandomPeer("get","/blocks/height",null,function(n,t){return n?e("Failed to get blocks height: "+n):(console.log("blockSync get block height",t),t.body&&t.body.success?bignum(o.height).gte(t.body.height)?e():void private_.findUpdate(o,t.peer,e):e("Failed to get blocks height: "+t.body))})})},private_.loadMultisignatures=function(e){modules.blockchain.accounts.getExecutor(function(n,t){if(n)return e(n);modules.api.multisignatures.pending(t.keypair.publicKey.toString("hex"),!0,function(n,o){if(n)return e(n.toString());var r=[],c=o.transactions;async.eachSeries(c,function(e,n){modules.api.multisignatures.sign(t.secret,null,e.transaction.id,function(e){e&&r.push(e),setImmediate(n)})},function(){if(r.length>0)return e(r[0]);e()})})})},Sync.prototype.onBind=function(e){modules=e},Sync.prototype.onBlockchainLoaded=function(){setImmediate(function e(){library.sequence.add(private_.blockSync,function(n){n&&library.logger("Sync#blockSync timer",n),setTimeout(e,1e4)})}),setImmediate(function e(){library.sequence.add(private_.transactionsSync,function(n){n&&library.logger("Sync#transactionsSync timer",n),setTimeout(e,1e4)})})},module.exports=Sync;