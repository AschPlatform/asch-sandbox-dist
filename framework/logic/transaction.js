"use strict";function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(i,a){try{var o=r[i](a),s=o.value}catch(e){return void t(e)}if(!o.done)return Promise.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}return n("next")})}}function Transaction(e,r){library=r,e(null,self=this)}var _slicedToArray=function(){function e(e,r){var t=[],n=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(t.push(o.value),!r||t.length!==r);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw a}}return t}return function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),assert=require("assert"),extend=require("extend"),bignum=require("bignumber"),ByteBuffer=require("bytebuffer"),slots=require("../helpers/slots.js"),helpers=require("../helpers"),private_={},self=null,library=null,modules=null;Transaction.prototype.create=function(e,r,t){var n={fee:e.fee,senderPublicKey:r.publicKey.toString("hex"),senderId:modules.blockchain.accounts.generateAddressByPublicKey(r.publicKey),timestamp:slots.getTime(),type:e.type,args:e.args};return n.signature=modules.api.crypto.sign(r,this.getBytes(n)),n.id=this.getId(n),n},Transaction.prototype.getId=function(e){return modules.api.crypto.getId(this.getBytes(e))},Transaction.prototype.getBytes=function(e,r){try{var t=new ByteBuffer(1,!0);t.writeInt(e.timestamp),t.writeString(e.fee);for(var n=new Buffer(e.senderPublicKey,"hex"),i=0;i<n.length;i++)t.writeByte(n[i]);if(t.writeInt(e.type),e.args&&t.writeString(e.args),!r&&e.signature)for(var a=new Buffer(e.signature,"hex"),i=0;i<a.length;i++)t.writeByte(a[i]);t.flip()}catch(r){throw console.log(e),Error(r.toString())}return t.toBuffer()},Transaction.prototype.verifyBytes=function(e,r,t){return modules.api.crypto.verify(e,r,t)},Transaction.prototype.verifySignature=function(e,r,t){if(!t)return!1;try{var n=self.getBytes(e,!0),i=modules.api.crypto.verify(r,t,n)}catch(e){throw Error(e.toString())}return i},Transaction.prototype.verify=function(e){if(e.timestamp>slots.getNow())throw new Error("Invalid timestamp");if(!e.type)throw new Error("Invalid function");try{var r=self.verifySignature(e,e.senderPublicKey,e.signature)}catch(e){throw new Error("verify signature exception: "+e)}return r},Transaction.prototype.apply=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,i,a,o,s,u,c,p,f,y;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(1===t.height){e.next=8;break}if(n=app.getFee(r.type)||app.defaultFee,!bignum(r.fee).lt(n.min)){e.next=4;break}throw new Error("Invalid transaction fee");case 4:if(!(i=app.balances.get(r.senderId,n.currency)).lt(r.fee)){e.next=7;break}throw new Error("Insufficient balance");case 7:app.balances.decrease(r.senderId,n.currency,r.fee);case 8:if(a=app.getContractName(r.type)){e.next=11;break}throw new Error("Unsupported transaction type");case 11:if(o=a.split("."),s=_slicedToArray(o,2),u=s[0],c=s[1],u&&c){e.next=14;break}throw new Error("Invalid transaction function");case 14:if(p=app.contract[u][c]){e.next=17;break}throw new Error("Contract not found");case 17:return f={trs:r,block:t},app.sdb.beginTransaction(),e.next=21,p.apply(f,JSON.parse(r.args));case 21:if(!(y=e.sent)){e.next=24;break}throw new Error(y);case 24:app.sdb.commitTransaction();case 25:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),Transaction.prototype.normalize=function(e){for(var r in e)null!==e[r]&&void 0!==e[r]||delete e[r];if(!library.validator.validate(e,{type:"object",properties:{id:{type:"string"},timestamp:{type:"integer"},senderId:{type:"string"},senderPublicKey:{type:"string",format:"publicKey"},fee:{type:"string"},signature:{type:"string",format:"signature"},type:{type:"integer"},args:{type:"string"}},required:["timestamp","senderPublicKey","fee","signature","type","args"]}))throw new Error(library.validator.getLastError().details[0].message)},Transaction.prototype.onBind=function(e){modules=e},module.exports=Transaction;