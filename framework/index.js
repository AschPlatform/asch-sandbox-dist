"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function Sandbox(){this.callbacks={},this.callbackCounter=1,this.messageHandler=null,this.dappMessageCb=null,EventEmitter.call(this)}var _setImmediate2=require("babel-runtime/core-js/set-immediate"),_setImmediate3=_interopRequireDefault(_setImmediate2),EventEmitter=require("events").EventEmitter,util=require("util");util.inherits(Sandbox,EventEmitter),Sandbox.prototype.processParentMessage=function(e){if("function"==typeof this.onMessage){var t=e;if(!t.callback_id)return void console.log("Incorrent response from parent, missed callback_id field");var a;try{a=parseInt(t.callback_id)}catch(e){return void console.log("Failed to convert callback_id to integer")}if(isNaN(a))return void console.log("Incorrect callback_id field, callback_id should be a number");if("asch_response"==t.type){if(!(s=this.callbacks[a]))return void console.log("Can't find callback_id from parent");var i=t.error,n=t.response;delete this.callbacks[a],(0,_setImmediate3.default)(s,i,n)}else if("asch_call"==t.type){var s=function(e,t){var i={type:"dapp_response",callback_id:a,error:e};!e&&t&&(i.response=t.response),this.emit("message",i)}.bind(this),r=t.message;"function"==typeof this.messageHandler&&(0,_setImmediate3.default)(this.messageHandler,r,a,s)}}},Sandbox.prototype._getCallbackCounter=function(){return this.callbackCounter++},Sandbox.prototype.onMessage=function(e){this.messageHandler=e},Sandbox.prototype.sendMessage=function(e,t){t||(t=function(){});var a=this._getCallbackCounter(),i={type:"dapp_call",callback_id:a,message:e};this.callbacks[a]=t,this.emit("message",i)},Sandbox.prototype.run=function(e){var t={sandbox:this};global.app=e,global.PIFY=require("./helpers/index").PIFY,require("./init")(t,function(e){e?(console.error("Failed to init: "+e),process.exit(2)):(console.log("Initialize complete"),this.emit("ready"))}.bind(this))};var instance=new Sandbox;process.exit=function(e){instance.emit("exit",e)},module.exports=instance;