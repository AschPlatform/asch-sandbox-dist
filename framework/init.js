"use strict";var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var async=require("async"),path=require("path"),ZSchema=require("z-schema"),extend=require("extend"),changeCase=require("change-case"),modules={},ready=!1;module.exports=function(r,e){app.logger.debug("enter init"),async.auto({sandbox:function(e){e(null,r.sandbox)},validator:function(e){ZSchema.registerFormat("publicKey",function(e){try{return 32==new Buffer(e,"hex").length}catch(e){return!1}}),ZSchema.registerFormat("signature",function(e){try{return 64==new Buffer(e,"hex").length}catch(e){return!1}}),ZSchema.registerFormat("hex",function(e){try{new Buffer(e,"hex")}catch(e){return!1}return!0}),ZSchema.prototype.getError=function(){var e=this.getLastErrors()[0];return e?e.message+": "+e.path:"unknow error"};var r=new ZSchema;e(null,r)},bus:function(e){var r=function(){this.message=function(){if(ready){var a=[];Array.prototype.push.apply(a,arguments);var t=a.shift();(0,_keys2.default)(modules).forEach(function(n){(0,_keys2.default)(modules[n]).forEach(function(e){var r="on"+changeCase.pascalCase(t);"function"==typeof modules[n][e][r]&&modules[n][e][r].apply(modules[n][e][r],a)})})}}};e(null,new r)},sequence:function(e){var r=new(require("./helpers/sequence.js"))({name:"Main",onWarning:function(e,r){app.logger.warn("Main queue",e)}});e(null,r)},modules:["sandbox","bus","sequence","validator",function(e,r){app.logger.debug("init modules");var n=require("./modules.full.json");for(var a in n){app.logger.debug("--------init module",a);var t=a.split("/"),u=t[0],o=t[1],i=new(require(n[a]))(function(){},r);modules[u]=modules[u]||{},modules[u][o]=i}e(null,modules)}],ready:["modules","bus",function(a,t){ready=!0,(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(){var r,n;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=path.join(app.rootDir,"init.js"),n=require(r),e.prev=2,e.next=5,n();case 5:t.bus.message("bind",t.modules),app.api=t.modules.api,a(),e.next=15;break;case 10:e.prev=10,e.t0=e.catch(2),app.logger.error("Failed to initialize app: ",e.t0),t.sandbox.emit("exit"),a("Initialize dapp failed");case 15:case"end":return e.stop()}},e,this,[[2,10]])}))()}]},e)};