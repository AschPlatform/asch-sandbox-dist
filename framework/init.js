"use strict";function _asyncToGenerator(e){return function(){var n=e.apply(this,arguments);return new Promise(function(e,r){function t(o,u){try{var a=n[o](u),s=a.value}catch(e){return void r(e)}if(!a.done)return Promise.resolve(s).then(function(e){t("next",e)},function(e){t("throw",e)});e(s)}return t("next")})}}var async=require("async"),path=require("path"),ZSchema=require("z-schema"),extend=require("extend"),changeCase=require("change-case"),modules={},ready=!1;module.exports=function(e,n){async.auto({sandbox:function(n){n(null,e.sandbox)},logger:function(e){e(null,console.log)},validator:function(e){ZSchema.registerFormat("publicKey",function(e){try{return 32==new Buffer(e,"hex").length}catch(e){return!1}}),ZSchema.registerFormat("signature",function(e){try{return 64==new Buffer(e,"hex").length}catch(e){return!1}}),ZSchema.registerFormat("hex",function(e){try{new Buffer(e,"hex")}catch(e){return!1}return!0}),ZSchema.prototype.getError=function(){var e=this.getLastErrors()[0];return e?e.message+": "+e.path:"unknow error"};var n=new ZSchema;e(null,n)},bus:function(e){e(null,new function(){this.message=function(){if(ready){var e=[];Array.prototype.push.apply(e,arguments);var n=e.shift();Object.keys(modules).forEach(function(r){Object.keys(modules[r]).forEach(function(t){var o="on"+changeCase.pascalCase(n);"function"==typeof modules[r][t][o]&&modules[r][t][o].apply(modules[r][t][o],e)})})}}})},sequence:function(e){var n=new(require("./helpers/sequence.js"))({name:"Main",onWarning:function(e,n){scope.logger.warn("Main queue",e)}});e(null,n)},modules:["sandbox","logger","bus","sequence","validator",function(e,n){var r=require("./modules.full.json"),t=[];Object.keys(r).forEach(function(e){var o=e.split("/"),u=o[0],a=o[1];t.push(function(t){var o=new(require(r[e]))(t,n);modules[u]=modules[u]||{},modules[u][a]=o})}),async.series(t,function(n){e(n,modules)})}],ready:["modules","bus","logger",function(e,n){ready=!0,_asyncToGenerator(regeneratorRuntime.mark(function e(){var n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=path.join(app.rootDir,"init.js"),r=require(n),e.prev=2,e.next=5,r();case 5:e.next=11;break;case 7:e.prev=7,e.t0=e.catch(2),console.log("Failed to initialize app: "+e.t0),process.exit(3);case 11:case"end":return e.stop()}},e,this,[[2,7]])}))(),n.bus.message("bind",n.modules),e()}]},n)};