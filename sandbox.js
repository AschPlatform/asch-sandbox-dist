"use strict";var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var fs=require("fs"),path=require("path"),spawn=require("child_process").spawn,util=require("util"),EventEmitter=require("events").EventEmitter;function Sandbox(e){var t=this;t._ready=!1,t._exited=!1,t._message_queue=[],t.options={timeout:0,node:"node",shovel:path.join(__dirname,"shovel2.js"),file:e.file,args:e.args}}util.inherits(Sandbox,EventEmitter),Sandbox.prototype.run=function(){var t=this,e=[this.options.shovel,this.options.file].concat(this.options.args);t.child=spawn(this.options.node,e,{stdio:["pipe","pipe","pipe","ipc"]}),t.child.stdout.on("data",function(e){t.emit("stdout",e.toString("utf8").replace(/\n$/,""))}),t.child.stderr.on("data",function(e){t.emit("stderr",e.toString("utf8").replace(/\n$/,""))}),t.child.on("message",function(e){if("__sandbox_inner_ready__"===e)for(t.emit("ready"),t._ready=!0;0<t._message_queue.length;)t.postMessage(t._message_queue.shift());else t.emit("message",e)}),t.child.on("exit",function(e){t.options.timeout,t.exited=!0,t.emit("exit",e)}),0<t.options.timeout&&(t.child.timer=setTimeout(function(){this.parent.stdout.removeListener("output",output),(0,_stringify2.default)({result:"TimeoutError",console:[]}),this.parent.kill("SIGKILL")},t.options.timeout),t.child.timer.parent=t.child)},Sandbox.prototype.kill=function(){var e=this;e._ready&&!e.exited&&e.child&&e.child.kill("SIGKILL")},Sandbox.prototype.postMessage=function(e){var t=this;t._ready?t.child.send(e):t._message_queue.push(e)},module.exports=Sandbox;